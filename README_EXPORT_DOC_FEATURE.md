# T√≠nh nƒÉng Upload Ch·ª©ng t·ª´ Xu·∫•t (EXPORT_DOC) - T·ªïng h·ª£p

## üéØ M·ª•c ti√™u

T·ª± ƒë·ªông h√≥a quy tr√¨nh x·ª≠ l√Ω y√™u c·∫ßu xu·∫•t (EXPORT) b·∫±ng c√°ch cho ph√©p admin upload nhi·ªÅu ch·ª©ng t·ª´ c√πng l√∫c v√† t·ª± ƒë·ªông chuy·ªÉn tr·∫°ng th√°i t·ª´ `PICK_CONTAINER` sang `SCHEDULED`.

## üîÑ Lu·ªìng ho·∫°t ƒë·ªông

```
1. Kh√°ch h√†ng t·∫°o y√™u c·∫ßu EXPORT ‚Üí Status: PENDING
2. Admin t·∫°o l·ªãch h·∫πn ‚Üí Status: PICK_CONTAINER  
3. Admin upload nhi·ªÅu ch·ª©ng t·ª´ c√πng l√∫c ‚Üí Status: SCHEDULED (T·ª± ƒë·ªông)
4. H·ªá th·ªëng x·ª≠ l√Ω ti·∫øp theo
```

## üèóÔ∏è Ki·∫øn tr√∫c h·ªá th·ªëng

### Backend
- **Routes**: `/requests/:id/docs` (single) v√† `/requests/:id/docs/multiple` (multiple) v·ªõi middleware RBAC
- **Controller**: `RequestController.uploadDoc()` v√† `RequestController.uploadMultipleDocs()`
- **Service**: `RequestService.uploadDocument()` v√† `RequestService.uploadMultipleDocuments()` v·ªõi auto status change
- **State Machine**: `RequestStateMachine` ƒë·ªÉ validate transitions
- **Validation**: Joi schema cho `EXPORT_DOC` type

### Frontend  
- **Component**: `DepotRequestTable` v·ªõi conditional rendering
- **Hook**: `useDepotActions.handleUploadDocument()` cho multiple files
- **API**: FormData upload v·ªõi multipart/form-data cho multiple files
- **State**: Loading states, error handling, success feedback v·ªõi s·ªë l∆∞·ª£ng files

## üìÅ File Structure

```
manageContainer/
‚îú‚îÄ‚îÄ backend/
‚îÇ   ‚îú‚îÄ‚îÄ modules/requests/
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ controller/
‚îÇ   ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ RequestRoutes.ts          # ‚úÖ Updated: Added multiple files upload routes
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RequestController.ts      # ‚úÖ Has uploadDoc and uploadMultipleDocs methods
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ service/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RequestService.ts         # ‚úÖ Updated: Added multiple files upload logic + auto status change
‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ dto/
‚îÇ   ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ RequestDtos.ts            # ‚úÖ Updated: Added EXPORT_DOC to uploadDocSchema
‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ service/
‚îÇ   ‚îÇ       ‚îî‚îÄ‚îÄ RequestStateMachine.ts    # ‚úÖ Has PICK_CONTAINER ‚Üí SCHEDULED transition
‚îÇ   ‚îî‚îÄ‚îÄ shared/middlewares/
‚îÇ       ‚îú‚îÄ‚îÄ auth.ts                       # ‚úÖ JWT authentication
‚îÇ       ‚îî‚îÄ‚îÄ rbac.ts                       # ‚úÖ Role-based access control
‚îú‚îÄ‚îÄ frontend/
‚îÇ   ‚îî‚îÄ‚îÄ pages/Requests/
‚îÇ       ‚îú‚îÄ‚îÄ components/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ DepotRequestTable.tsx      # ‚úÖ Updated: Added multiple files upload button + new columns
‚îÇ       ‚îú‚îÄ‚îÄ hooks/
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ useDepotActions.ts         # ‚úÖ Updated: Added handleUploadDocument for multiple files
‚îÇ       ‚îú‚îÄ‚îÄ Depot.tsx                      # ‚úÖ Updated: Uses DepotRequestTable
‚îÇ       ‚îî‚îÄ‚îÄ styles/
‚îÇ           ‚îî‚îÄ‚îÄ DepotRequestTable.css      # ‚úÖ Added styling for new elements
‚îî‚îÄ‚îÄ docs/
    ‚îú‚îÄ‚îÄ EXPORT_DOC_UPLOAD_FEATURE.md      # ‚úÖ Backend documentation
    ‚îî‚îÄ‚îÄ EXPORT_DOC_UPLOAD_FRONTEND.md     # ‚úÖ Frontend documentation
```

## üöÄ C√°ch s·ª≠ d·ª•ng

### 1. ƒêƒÉng nh·∫≠p v·ªõi role c√≥ quy·ªÅn
- `SystemAdmin` ‚úÖ
- `BusinessAdmin` ‚úÖ  
- `SaleAdmin` ‚úÖ

### 2. T√¨m y√™u c·∫ßu EXPORT v·ªõi status PICK_CONTAINER
- V√†o trang "Y√™u c·∫ßu (Depot)"
- T√¨m row c√≥:
  - **Lo·∫°i**: EXPORT
  - **Tr·∫°ng th√°i**: ƒêANG CH·ªåN CONTAINER
  - **Ch·ª©ng t·ª´**: C√≥ n√∫t "üìé Th√™m ch·ª©ng t·ª´"

### 3. Click "Th√™m ch·ª©ng t·ª´"
- Ch·ªçn file PDF, JPG, ho·∫∑c PNG (t·ªëi ƒëa 10MB)
- H·ªá th·ªëng t·ª± ƒë·ªông upload v√† chuy·ªÉn tr·∫°ng th√°i
- Hi·ªÉn th·ªã th√¥ng b√°o th√†nh c√¥ng

## üîß Technical Implementation

### Backend Changes

#### 1. RequestRoutes.ts
```typescript
// ‚úÖ Added SystemAdmin, BusinessAdmin roles
router.post('/:id/docs', requireRoles('SaleAdmin','Accountant','CustomerAdmin','CustomerUser','SystemAdmin','BusinessAdmin'), upload.single('file'), (req, res) => controller.uploadDoc(req as any, res));
```

#### 2. RequestDtos.ts  
```typescript
// ‚úÖ Added EXPORT_DOC to validation schema
export const uploadDocSchema = Joi.object({
    type: Joi.string().valid('EIR','LOLO','INVOICE','SUPPLEMENT','EXPORT_DOC').required()
});
```

#### 3. RequestService.ts
```typescript
// ‚úÖ Added EXPORT_DOC validation and auto status change
if (type === 'EXPORT_DOC') {
    // Validation logic
    if (req.status !== 'PICK_CONTAINER') {
        throw new Error('Ch·ªâ upload ch·ª©ng t·ª´ xu·∫•t khi y√™u c·∫ßu ƒëang ·ªü tr·∫°ng th√°i ch·ªçn container');
    }
    if (req.type !== 'EXPORT') {
        throw new Error('Ch·ªâ upload ch·ª©ng t·ª´ xu·∫•t cho y√™u c·∫ßu lo·∫°i EXPORT');
    }
    if (!['SaleAdmin', 'SystemAdmin', 'BusinessAdmin'].includes(actor.role)) {
        throw new Error('Ch·ªâ admin ƒë∆∞·ª£c upload ch·ª©ng t·ª´ xu·∫•t');
    }
    
    // Auto status change
    const canTransition = RequestStateMachine.canTransition(req.status, 'SCHEDULED', actor.role);
    if (canTransition) {
        await RequestStateMachine.executeTransition(actor, request_id, req.status, 'SCHEDULED', 'T·ª± ƒë·ªông chuy·ªÉn tr·∫°ng th√°i sau khi upload ch·ª©ng t·ª´ xu·∫•t');
        
        const updatedRequest = await repo.update(request_id, {
            status: 'SCHEDULED',
            history: [...req.history, {
                at: new Date().toISOString(),
                by: actor._id,
                action: 'SCHEDULED',
                reason: 'T·ª± ƒë·ªông chuy·ªÉn tr·∫°ng th√°i sau khi upload ch·ª©ng t·ª´ xu·∫•t',
                document_id: doc.id,
                document_type: 'EXPORT_DOC'
            }]
        });
    }
}
```

### Frontend Changes

#### 1. DepotRequestTable.tsx
```typescript
// ‚úÖ Added new columns
<th>Lo·∫°i</th>
<th>Container</th>
<th>V·ªã tr√≠</th>         {/* ‚úÖ New column for EXPORT requests */}

// ‚úÖ Added conditional upload button
{item.type === 'EXPORT' && item.status === 'PICK_CONTAINER' && onAddDocument ? (
    <button className="btn btn-sm btn-primary" onClick={() => onAddDocument(item.id, item.container_no || '')}>
        üìé Th√™m ch·ª©ng t·ª´
    </button>
) : (
    <span className="no-document">-</span>
)}

// ‚úÖ Added location display for EXPORT requests
<td>
    <div className="location-info">
        {item.type === 'EXPORT' ? (
            <span className="location-badge">
                üìç {getContainerLocation(item.container_no) || 'Ch∆∞a x√°c ƒë·ªãnh'}
            </span>
        ) : (
            <span className="location-na">-</span>
        )}
    </div>
</td>
```

#### 2. useDepotActions.ts
```typescript
// ‚úÖ Added handleAddDocument method
const handleAddDocument = async (requestId: string, containerNo: string) => {
    setLoadingId(requestId + 'ADD_DOC');
    try {
        // Create hidden file input
        const fileInput = document.createElement('input');
        fileInput.type = 'file';
        fileInput.accept = '.pdf,.jpg,.jpeg,.png';
        
        fileInput.onchange = async (event) => {
            const file = (event.target as HTMLInputElement).files?.[0];
            if (!file) return;
            
            // File validation
            const allowedTypes = ['application/pdf', 'image/jpeg', 'image/jpg', 'image/png'];
            if (!allowedTypes.includes(file.type)) {
                setMsg({ text: 'Ch·ªâ ch·∫•p nh·∫≠n file PDF ho·∫∑c ·∫£nh (JPG, PNG)', ok: false });
                return;
            }
            
            // Create FormData and upload
            const formData = new FormData();
            formData.append('file', file);
            formData.append('type', 'EXPORT_DOC');
            
            const response = await api.post(`/requests/${requestId}/docs`, formData, {
                headers: { 'Content-Type': 'multipart/form-data' }
            });
            
            // Success feedback
            setMsg({ 
                text: `‚úÖ ƒê√£ upload ch·ª©ng t·ª´ th√†nh c√¥ng cho container ${containerNo}! Tr·∫°ng th√°i ƒë√£ t·ª± ƒë·ªông chuy·ªÉn t·ª´ PICK_CONTAINER sang SCHEDULED.`, 
                ok: true 
            });
            
            // Refresh data
            mutate('/requests?page=1&limit=20');
        };
        
        fileInput.click();
        
    } catch (e: any) {
        setMsg({ text: `Kh√¥ng th·ªÉ th√™m ch·ª©ng t·ª´: ${e?.response?.data?.message || 'L·ªói'}`, ok: false });
    } finally {
        setLoadingId('');
    }
};
```

#### 3. Depot.tsx
```typescript
// ‚úÖ Updated to use DepotRequestTable with onAddDocument prop
<DepotRequestTable 
    // ... other props
    onAddDocument={actions.handleAddDocument}  // ‚úÖ New prop
    // ... other props
/>
```

## üß™ Testing

### Test Cases
1. **‚úÖ Success Case**: Upload multiple PDF files cho EXPORT request v·ªõi status PICK_CONTAINER
2. **‚úÖ Success Case**: Upload mixed files (PDF + JPG + PNG) cho EXPORT request v·ªõi status PICK_CONTAINER
3. **‚ùå Too Many Files Error**: Upload qu√° 10 files c√πng l√∫c
4. **‚ùå File Type Error**: Upload file kh√¥ng h·ª£p l·ªá (txt, docx)
5. **‚ùå File Size Error**: Upload file qu√° 10MB
6. **‚ùå Request Type Error**: Upload cho IMPORT request
7. **‚ùå Status Error**: Upload cho request v·ªõi status kh√°c PICK_CONTAINER
8. **‚ùå Role Error**: Upload v·ªõi role kh√¥ng c√≥ quy·ªÅn

### Manual Testing Steps
1. T·∫°o y√™u c·∫ßu EXPORT
2. T·∫°o l·ªãch h·∫πn ƒë·ªÉ chuy·ªÉn status sang PICK_CONTAINER
3. Click "Upload documents"
4. Ch·ªçn nhi·ªÅu files PDF/JPG/PNG (t·ªëi ƒëa 10 files)
5. Verify upload th√†nh c√¥ng v√† status chuy·ªÉn sang SCHEDULED

## üêõ Troubleshooting

### Common Issues

#### 1. L·ªói 403 Forbidden
- **Nguy√™n nh√¢n**: Role kh√¥ng c√≥ quy·ªÅn upload
- **Gi·∫£i ph√°p**: ƒêƒÉng nh·∫≠p v·ªõi role SystemAdmin, BusinessAdmin, ho·∫∑c SaleAdmin

#### 2. L·ªói 400 Bad Request
- **Nguy√™n nh√¢n**: File kh√¥ng h·ª£p l·ªá ho·∫∑c validation fail
- **Gi·∫£i ph√°p**: Ki·ªÉm tra file type (PDF, JPG, PNG) v√† size (t·ªëi ƒëa 10MB)

#### 3. Status kh√¥ng chuy·ªÉn
- **Nguy√™n nh√¢n**: State machine transition kh√¥ng ƒë∆∞·ª£c ph√©p
- **Gi·∫£i ph√°p**: Ki·ªÉm tra request status ph·∫£i l√† PICK_CONTAINER v√† type ph·∫£i l√† EXPORT

### Debug Commands
```bash
# Backend logs
tail -f logs/app.log | grep "EXPORT_DOC"

# Database check
db.requests.findOne({_id: "request_id"})
db.documents.find({request_id: "request_id", type: "EXPORT_DOC"})
```

## üìä Monitoring

### Success Metrics
- Upload success rate
- Auto status change success rate
- Processing time
- User adoption rate

### Error Tracking
- File validation failures
- Role permission errors
- State machine transition failures
- API errors

## üîÆ Future Enhancements

### Potential Improvements
1. **‚úÖ Bulk Upload**: Upload nhi·ªÅu file c√πng l√∫c (ƒê√£ implement)
2. **Progress Bar**: Hi·ªÉn th·ªã ti·∫øn tr√¨nh upload cho t·ª´ng file
3. **File Preview**: Preview file tr∆∞·ªõc khi upload
4. **Drag & Drop**: K√©o th·∫£ file ƒë·ªÉ upload
5. **Auto-retry**: T·ª± ƒë·ªông th·ª≠ l·∫°i khi upload fail
6. **File Compression**: N√©n file tr∆∞·ªõc khi upload
7. **Batch Processing**: X·ª≠ l√Ω files theo batch ƒë·ªÉ t·ªëi ∆∞u performance

### Integration Opportunities
1. **Email Notifications**: G·ª≠i email khi status thay ƒë·ªïi
2. **SMS Alerts**: G·ª≠i SMS cho kh√°ch h√†ng
3. **Webhook**: Trigger external systems
4. **Analytics**: Track user behavior patterns

## üìö References

- [Backend Documentation](./backend/docs/EXPORT_DOC_UPLOAD_FEATURE.md)
- [Frontend Documentation](./frontend/docs/EXPORT_DOC_UPLOAD_FRONTEND.md)
- [API Documentation](./backend/docs/MODULE_3_REQUESTS.md)
- [State Machine Documentation](./backend/docs/AUTO_FORWARD_FEATURE.md)

## üë• Team

- **Backend Developer**: Implemented RequestService, Routes, Controller
- **Frontend Developer**: Implemented Components, Hooks, UI
- **DevOps**: Deployment v√† monitoring
- **QA**: Testing v√† validation

## üìÖ Timeline

- **Phase 1**: Backend implementation ‚úÖ
- **Phase 2**: Frontend implementation ‚úÖ  
- **Phase 3**: Testing v√† bug fixes ‚úÖ
- **Phase 4**: Documentation ‚úÖ
- **Phase 5**: Production deployment üöÄ

---

**Status**: ‚úÖ Complete  
**Last Updated**: January 6, 2025  
**Version**: 1.0.0
