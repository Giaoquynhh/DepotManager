# Module 3 ‚Äî Qu·∫£n l√Ω Y√™u c·∫ßu D·ªãch v·ª• & Ch·ª©ng t·ª´

M·ª•c ti√™u: qu·∫£n l√Ω v√≤ng ƒë·ªùi y√™u c·∫ßu d·ªãch v·ª• container (t·∫°o ‚Üí x·ª≠ l√Ω ‚Üí ho√†n t·∫•t), v√† qu·∫£n l√Ω ch·ª©ng t·ª´ (EIR/LOLO/H√≥a ƒë∆°n) k√®m version. Ph√¢n quy·ªÅn: Customer (Admin/User), SaleAdmin, Accountant.

## 1) Data model (Prisma)
- `ServiceRequest(id, tenant_id, created_by, type, container_no, eta, status, history, createdAt, updatedAt)`
- `DocumentFile(id, request_id, type, name, size, version, uploader_id, storage_key, createdAt, deleted_at?, deleted_by?, delete_reason?)`
  - Type: EIR | LOLO | INVOICE | SUPPLEMENT | INITIAL_DOC
- `PaymentRequest(id, request_id, created_by, status, createdAt)`

Status: PENDING | RECEIVED | SCHEDULED | SCHEDULED_INFO_ADDED | FORWARDED | SENT_TO_GATE | REJECTED | COMPLETED | EXPORTED | IN_YARD | LEFT_YARD

## 2) RBAC
- CustomerAdmin/CustomerUser: t·∫°o/list y√™u c·∫ßu trong tenant; xem ch·ª©ng t·ª´ c·ªßa tenant; upload t√†i li·ªáu b·ªï sung khi status = SCHEDULED.
- SaleAdmin: nh·∫≠n/t·ª´ ch·ªëi y√™u c·∫ßu; t·∫°o m·ªõi thay kh√°ch; upload/x√≥a EIR/LOLO; g·ª≠i y√™u c·∫ßu thanh to√°n; chuy·ªÉn ti·∫øp y√™u c·∫ßu sau khi nh·∫≠n t√†i li·ªáu b·ªï sung.
- Accountant: upload/x√≥a INVOICE; xem requests/docs.

## 3) API
Base: `/requests` (JWT)

### 3.1. T·∫°o y√™u c·∫ßu
- Customer (t·∫°o):
  - `POST /requests`
  - Body: `{ type: 'IMPORT'|'EXPORT'|'CONVERT', container_no, eta? }`
  - 201 ‚Üí Request PENDING
- SaleAdmin (t·∫°o thay kh√°ch):
  - `POST /requests` (role=SaleAdmin) ‚Üí status `RECEIVED`

### 3.2. Danh s√°ch/Tra c·ª©u
- `GET /requests?type=&status=&page=&limit=`
  - Customer: auto filter theo tenant_id
  - SaleAdmin/Accountant: xem t·∫•t c·∫£

### 3.3. C·∫≠p nh·∫≠t tr·∫°ng th√°i (Depot)
- `PATCH /requests/:id/status`
  - Body: `{ status: 'RECEIVED'|'REJECTED'|'COMPLETED'|'EXPORTED', reason? }`
  - RBAC: SaleAdmin
  - Lu·ªìng tr·∫°ng th√°i h·ª£p l·ªá (state machine):
    - `PENDING ‚Üí SCHEDULED | REJECTED`
    - `SCHEDULED ‚Üí SCHEDULED_INFO_ADDED | FORWARDED | REJECTED`
    - `SCHEDULED_INFO_ADDED ‚Üí FORWARDED | REJECTED`
    - `FORWARDED ‚Üí COMPLETED | SENT_TO_GATE`
    - `SENT_TO_GATE ‚Üí COMPLETED`
    - `COMPLETED ‚Üí EXPORTED | IN_YARD`
    - `IN_YARD ‚Üí LEFT_YARD`
    - `LEFT_YARD`/`EXPORTED`/`REJECTED` l√† tr·∫°ng th√°i cu·ªëi (kh√¥ng chuy·ªÉn ti·∫øp)
  - Y√™u c·∫ßu nh·∫≠p `reason` khi chuy·ªÉn sang `REJECTED`

### 3.4. Reject request (Depot)
- `PATCH /requests/:id/reject`
  - Body: `{ reason?: string }`
  - RBAC: SaleAdmin, SystemAdmin
  - Ch·ªâ cho ph√©p reject khi `status IN ('PENDING','RECEIVED','IN_YARD')`
  - C·∫≠p nh·∫≠t: `status='REJECTED'`, `rejected_reason`, `rejected_by`, `rejected_at`

### 3.5. Soft-delete theo scope
- `DELETE /requests/:id?scope=depot|customer`
  - RBAC: T·∫•t c·∫£ roles (theo scope)
  - Depot: ch·ªâ x√≥a `REJECTED`, `COMPLETED`, `EXPORTED`
  - Customer: ch·ªâ x√≥a `REJECTED` (v√† thu·ªôc tenant c·ªßa h·ªç)
  - Set `depot_deleted_at` ho·∫∑c `customer_deleted_at` = now()

### 3.6. Restore theo scope
- `POST /requests/:id/restore?scope=depot|customer`
  - RBAC: T·∫•t c·∫£ roles (theo scope)
  - Reset `depot_deleted_at` ho·∫∑c `customer_deleted_at` = null

### 3.7. Ch·ª©ng t·ª´
- Upload (AC1/AC5):
  - `POST /requests/:id/docs` (multipart: `file`, body: `{ type: 'EIR'|'LOLO'|'INVOICE'|'SUPPLEMENT' }`)
  - EIR/LOLO/INVOICE: ch·ªâ khi status ‚àà { COMPLETED, EXPORTED }
  - SUPPLEMENT: ch·ªâ khi status = SCHEDULED (Customer only)
  - **T·ª± ƒë·ªông chuy·ªÉn tr·∫°ng th√°i:** `SCHEDULED ‚Üí FORWARDED` sau khi upload th√†nh c√¥ng
  - **State Machine validation:** S·ª≠ d·ª•ng `RequestStateMachine` ƒë·ªÉ validate v√† execute transitions
  - **Enhanced logging:** Detailed logs cho debugging v√† monitoring
  - **Graceful degradation:** N·∫øu transition th·∫•t b·∫°i, upload v·∫´n th√†nh c√¥ng
  - Mimetype: pdf/jpeg/png, size ‚â§ 10MB ‚Üí version tƒÉng t·ª± ƒë·ªông (v1, v2, ...)
  - RBAC: EIR/LOLO (SaleAdmin), INVOICE (Accountant), SUPPLEMENT (CustomerAdmin/CustomerUser)
- Upload khi t·∫°o request (Customer):
  - `POST /requests` (multipart: `document`, body: `{ type, container_no, eta? }`)
  - File ƒë∆∞·ª£c l∆∞u v·ªõi type `INITIAL_DOC`
  - H·ªó tr·ª£: PDF, JPG, PNG (t·ªëi ƒëa 10MB)
- Danh s√°ch:
  - `GET /requests/:id/docs?type=SUPPLEMENT` (filter theo type)
  - RBAC: SaleAdmin/Accountant/Customer* (tenant scope)
- Serve files:
  - `GET /requests/documents/:filename`
  - Tr·∫£ v·ªÅ file t·ª´ th∆∞ m·ª•c uploads
  - Kh√¥ng c·∫ßn authentication (public access)
- X√≥a (AC4):
  - `DELETE /requests/:id/docs/:docId` (Body: `{reason}` optional)
  - RBAC: ng∆∞·ªùi upload, ho·∫∑c SystemAdmin/BusinessAdmin/SaleAdmin/Accountant
  - Soft-delete: l∆∞u `deleted_at/by/reason`; audit

### 3.8. Y√™u c·∫ßu thanh to√°n (US 3.4)
- `POST /requests/:id/payment-request` (SaleAdmin)
  - Ch·ªâ cho ph√©p khi `status = COMPLETED`
  - Tr·∫£ `PaymentRequest` status `SENT` ‚Üí Accountant ti·∫øp nh·∫≠n (lu·ªìng ti·∫øp theo s·∫Ω m·ªü r·ªông)

### 3.9. T√†i li·ªáu b·ªï sung & H√†nh ƒë·ªông Depot
- Upload t√†i li·ªáu b·ªï sung (Customer):
  - `POST /requests/:id/docs` v·ªõi `type: 'SUPPLEMENT'`
  - Ch·ªâ khi status = SCHEDULED
  - RBAC: CustomerAdmin/CustomerUser (tenant scope)
- Danh s√°ch t√†i li·ªáu b·ªï sung:
  - `GET /requests/:id/docs?type=SUPPLEMENT`
  - Customer: ch·ªâ xem file c·ªßa tenant m√¨nh
  - Depot: xem t·∫•t c·∫£ file
- Chuy·ªÉn ti·∫øp y√™u c·∫ßu (Depot):
  - `PATCH /requests/:id/status` v·ªõi `status: 'FORWARDED'`
  - RBAC: SaleAdmin/SystemAdmin
  - Ch·ªâ khi status = SCHEDULED
- T·ª´ ch·ªëi y√™u c·∫ßu (Depot):
  - `PATCH /requests/:id/reject` v·ªõi `reason`
  - RBAC: SaleAdmin/SystemAdmin
  - Ch·ªâ khi status ‚àà {SCHEDULED, RECEIVED}

## 4) Soft-delete theo scope
- **M·ª•c ti√™u**: Cho ph√©p Kho v√† Kh√°ch h√†ng x√≥a/·∫©n request theo ph·∫°m vi ri√™ng
- **C∆° ch·∫ø**: S·ª≠ d·ª•ng `depot_deleted_at` v√† `customer_deleted_at` ƒë·ªÉ track soft-delete
- **Quy t·∫Øc**:
  - Depot: c√≥ th·ªÉ x√≥a `REJECTED`, `COMPLETED`, `EXPORTED`
  - Customer: ch·ªâ c√≥ th·ªÉ x√≥a `REJECTED` (v√† thu·ªôc tenant c·ªßa h·ªç)
  - Request v·∫´n t·ªìn t·∫°i trong DB, ch·ªâ ·∫©n theo scope t∆∞∆°ng ·ª©ng
  - Audit log ghi l·∫°i h√†nh ƒë·ªông `REQUEST.DELETED` v√† `REQUEST.RESTORED`

## 5) L∆∞u tr·ªØ file
- Demo: l∆∞u local t·∫°i `backend/uploads/` v·ªõi t√™n `{timestamp}_{request_id}{extension}` (c·∫•u h√¨nh trong `RequestRoutes.ts`).
- File ƒë∆∞·ª£c l∆∞u v·ªõi `storage_key` trong database ƒë·ªÉ tracking.
- API endpoint `/requests/documents/:filename` ƒë·ªÉ serve files tr·ª±c ti·∫øp.
- S·∫£n ph·∫©m: thay b·∫±ng S3/Azure Blob + signed URL.

## 6) Audit
- `REQUEST.CREATED|RECEIVED|REJECTED|COMPLETED|EXPORTED`
- `DOC.UPLOADED|DOC.DELETED`
- `PAYMENT.SENT`

## 6.1) T√≠nh nƒÉng xem ·∫£nh (Image Viewer)
- **Frontend**: Modal popup hi·ªÉn th·ªã ·∫£nh tr·ª±c ti·∫øp khi click v√†o document badge
- **H·ªó tr·ª£ ƒë·ªãnh d·∫°ng**: JPG, JPEG, PNG, GIF, BMP, WEBP
- **File kh√¥ng ph·∫£i ·∫£nh**: Hi·ªÉn th·ªã th√¥ng tin file + link t·∫£i xu·ªëng
- **API**: `GET /requests/documents/:filename` (public access)
- **Responsive**: Modal t·ª± ƒë·ªông ƒëi·ªÅu ch·ªânh k√≠ch th∆∞·ªõc
- **UX**: Click b√™n ngo√†i ho·∫∑c n√∫t X ƒë·ªÉ ƒë√≥ng modal

## 6.2) Chat System theo ƒë∆°n h√†ng
- **M·ª•c ti√™u**: K·∫øt n·ªëi Customer v√† Depot Staff qua box chat real-time
- **T·ª± ƒë·ªông t·∫°o**: Chat room ƒë∆∞·ª£c t·∫°o t·ª± ƒë·ªông khi t·∫°o request m·ªõi
- **System messages**: T·ª± ƒë·ªông g·ª≠i th√¥ng b√°o khi tr·∫°ng th√°i ƒë∆°n h√†ng thay ƒë·ªïi
- **WebSocket**: Real-time messaging v·ªõi Socket.IO
- **RBAC**: Ph√¢n quy·ªÅn truy c·∫≠p theo role v√† tenant
- **File upload**: H·ªó tr·ª£ upload file trong chat (·∫£nh, PDF)
- **UI**: Modal popup v·ªõi auto-scroll v√† responsive design

### 6.2.1) API Chat System
- `POST /chat` - T·∫°o chat room
- `GET /chat/request/:request_id` - L·∫•y chat room theo request
- `POST /chat/:chat_room_id/messages` - G·ª≠i tin nh·∫Øn
- `GET /chat/:chat_room_id/messages` - L·∫•y danh s√°ch tin nh·∫Øn
- `GET /chat/user/rooms` - L·∫•y danh s√°ch chat rooms c·ªßa user

### 6.2.2) WebSocket Events
- `join_chat_room` - Tham gia chat room
- `leave_chat_room` - R·ªùi chat room
- `send_message` - G·ª≠i tin nh·∫Øn
- `new_message` - Nh·∫≠n tin nh·∫Øn m·ªõi
- `system_message` - Nh·∫≠n system message

### 6.2.3) Chat Status Integration

#### 6.2.3.1) Status Messages
H·ªá th·ªëng t·ª± ƒë·ªông hi·ªÉn th·ªã th√¥ng b√°o tr·∫°ng th√°i trong chat:

| Tr·∫°ng th√°i | Message | Icon |
|------------|---------|------|
| PENDING | üìã ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c t·∫°o v√† ƒëang ch·ªù x·ª≠ l√Ω | üìã |
| RECEIVED | ‚úÖ ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c ti·∫øp nh·∫≠n v√† ƒëang x·ª≠ l√Ω | ‚úÖ |
| IN_PROGRESS | üîÑ ƒê∆°n h√†ng ƒëang ƒë∆∞·ª£c x·ª≠ l√Ω t·∫°i kho | üîÑ |
| COMPLETED | ‚úÖ ƒê∆°n h√†ng ƒë√£ ho√†n t·∫•t | ‚úÖ |
| EXPORTED | üì¶ ƒê∆°n h√†ng ƒë√£ xu·∫•t kho | üì¶ |
| REJECTED | ‚ùå ƒê∆°n h√†ng b·ªã t·ª´ ch·ªëi: [l√Ω do] | ‚ùå |
| CANCELLED | ‚ùå ƒê∆°n h√†ng ƒë√£ b·ªã h·ªßy | ‚ùå |
| IN_YARD | üè≠ Container ƒë√£ v√†o kho | üè≠ |
| LEFT_YARD | üöõ Container ƒë√£ r·ªùi kho | üöõ |

#### 6.2.3.2) Chat Restrictions
- **Ch·ªâ cho ph√©p chat** khi tr·∫°ng th√°i: `APPROVED`, `IN_PROGRESS`, `COMPLETED`, `EXPORTED`
- **Kh√¥ng cho ph√©p chat** khi tr·∫°ng th√°i: `PENDING`, `REJECTED`, `CANCELLED`
- **System messages** ƒë∆∞·ª£c g·ª≠i cho m·ªçi tr·∫°ng th√°i (kh√¥ng b·ªã gi·ªõi h·∫°n)

#### 6.2.3.3) Welcome Message
M·ªói chat room hi·ªÉn th·ªã welcome message v·ªõi th√¥ng tin:
- Lo·∫°i ƒë∆°n h√†ng (Import/Export)
- S·ªë container
- Tr·∫°ng th√°i hi·ªán t·∫°i

#### 6.2.3.4) Rejection Reason Display
Khi ƒë∆°n h√†ng b·ªã t·ª´ ch·ªëi:
- Hi·ªÉn th·ªã l√Ω do t·ª´ ch·ªëi trong system message
- Hi·ªÉn th·ªã l√Ω do trong warning banner
- Disable chat input v√† n√∫t g·ª≠i tin nh·∫Øn

### 6.3) Soft-Delete Functionality

#### 6.3.1) Overview
H·ªá th·ªëng h·ªó tr·ª£ **soft-delete theo ph·∫°m vi** (scope-based soft delete) cho ph√©p:
- **Kho (Depot)**: ·∫®n request ƒë√£ reject/cancel/complete kh·ªèi danh s√°ch
- **Kh√°ch h√†ng**: ·∫®n request ƒë√£ reject/cancel kh·ªèi danh s√°ch
- **Kh√¥ng x√≥a c·ª©ng** kh·ªèi database ƒë·ªÉ ƒë·∫£m b·∫£o audit trail

#### 6.3.2) Business Rules
| Tr·∫°ng th√°i Request | Kho c√≥ th·ªÉ x√≥a? | Kh√°ch h√†ng c√≥ th·ªÉ x√≥a? | Ghi ch√∫ |
|-------------------|-----------------|----------------------|---------|
| PENDING / APPROVED / IN_PROGRESS | ‚ùå | ‚ùå | Kh√¥ng cho x√≥a ƒë·ªÉ tr√°nh m·∫•t vi·ªác ƒëang x·ª≠ l√Ω |
| REJECTED | ‚úÖ (·∫©n kh·ªèi danh s√°ch Kho) | ‚úÖ (·∫©n kh·ªèi danh s√°ch Kh√°ch) | Tr·∫°ng th√°i hi·ªÉn th·ªã ph√≠a c√≤n l·∫°i v·∫´n l√† **Rejected** |
| CANCELLED | ‚úÖ | ‚úÖ | T∆∞∆°ng t·ª± REJECTED |
| COMPLETED | ‚úÖ | ‚ùå | Kho c√≥ th·ªÉ d·ªçn danh s√°ch; Kh√°ch gi·ªØ l·ªãch s·ª≠ |

#### 6.3.3) Database Schema
```sql
-- Th√™m c·ªôt soft-delete v√†o b·∫£ng requests
ALTER TABLE requests 
ADD COLUMN depot_deleted_at TIMESTAMP NULL,
ADD COLUMN customer_deleted_at TIMESTAMP NULL,
ADD COLUMN rejected_reason TEXT NULL,
ADD COLUMN rejected_by UUID NULL,
ADD COLUMN rejected_at TIMESTAMP NULL;

-- Indexes cho performance
CREATE INDEX idx_requests_depot_deleted_at ON requests(depot_deleted_at);
CREATE INDEX idx_requests_customer_deleted_at ON requests(customer_deleted_at);
CREATE INDEX idx_requests_status ON requests(status);
```

#### 6.3.4) API Endpoints

##### Reject Request (Kho)
```http
PATCH /requests/{id}/reject
Content-Type: application/json
Authorization: Bearer <token>

{
  "reason": "Thi·∫øu ch·ª©ng t·ª´ v·∫≠n ƒë∆°n"
}
```

**Response:**
```json
{
  "id": "uuid",
  "status": "REJECTED",
  "rejected_reason": "Thi·∫øu ch·ª©ng t·ª´ v·∫≠n ƒë∆°n",
  "rejected_by": "user-uuid",
  "rejected_at": "2024-01-15T10:30:00Z"
}
```

##### Soft-Delete theo Scope
```http
DELETE /requests/{id}?scope=depot|customer
Authorization: Bearer <token>
```

**Response:**
```json
{
  "ok": true,
  "id": "uuid",
  "scope": "depot",
  "deleted_at": "2024-01-15T10:30:00Z"
}
```

##### Restore theo Scope
```http
POST /requests/{id}/restore?scope=depot|customer
Authorization: Bearer <token>
```

**Response:**
```json
{
  "ok": true,
  "id": "uuid",
  "scope": "depot",
  "restored_at": "2024-01-15T10:30:00Z"
}
```

#### 6.3.5) Implementation Code

##### Service Layer (RequestService.ts)
```typescript
// Reject request
async rejectRequest(id: string, reason: string, actor: User) {
  const request = await this.repo.findById(id);
  if (!request) throw new Error('Request not found');
  
  // Ki·ªÉm tra quy·ªÅn v√† tr·∫°ng th√°i
  if (!['PENDING', 'APPROVED', 'IN_PROGRESS'].includes(request.status)) {
    throw new Error('Cannot reject request in current status');
  }
  
  // C·∫≠p nh·∫≠t tr·∫°ng th√°i
  const updated = await this.repo.update(id, {
    status: 'REJECTED',
    rejected_reason: reason,
    rejected_by: actor._id,
    rejected_at: new Date()
  });
  
  // Audit log
  await audit(actor._id, 'REQUEST.REJECTED', 'REQUEST', id, { reason });
  
  // G·ª≠i system message v√†o chat room
  try {
    const chatRoom = await chatService.getChatRoom(actor, id);
    if (chatRoom) {
      const systemMessage = `‚ùå ƒê∆°n h√†ng b·ªã t·ª´ ch·ªëi${reason ? `: ${reason}` : ''}`;
      await chatService.sendSystemMessageUnrestricted(chatRoom.id, systemMessage);
    }
  } catch (error) {
    console.error('Kh√¥ng th·ªÉ g·ª≠i system message khi reject:', error);
  }
  
  return updated;
}

// Soft-delete theo scope
async softDelete(id: string, scope: 'depot' | 'customer', actor: User) {
  const request = await this.repo.findById(id);
  if (!request) throw new Error('Request not found');
  
  if (scope === 'depot') {
    // Ki·ªÉm tra quy·ªÅn Kho
    if (!['SaleAdmin', 'Accountant', 'SystemAdmin'].includes(actor.role)) {
      throw new Error('Unauthorized for depot scope');
    }
    
    // Ki·ªÉm tra tr·∫°ng th√°i cho ph√©p x√≥a
    if (!['REJECTED', 'CANCELLED', 'COMPLETED'].includes(request.status)) {
      throw new Error('Depot can only delete rejected/cancelled/completed requests');
    }
    
    await this.repo.update(id, { depot_deleted_at: new Date() });
  } else {
    // Ki·ªÉm tra quy·ªÅn Kh√°ch h√†ng
    if (!['CustomerAdmin', 'CustomerUser'].includes(actor.role)) {
      throw new Error('Unauthorized for customer scope');
    }
    
    // Ki·ªÉm tra request thu·ªôc tenant c·ªßa user
    if (request.tenant_id !== actor.tenant_id) {
      throw new Error('Request does not belong to your organization');
    }
    
    // Ki·ªÉm tra tr·∫°ng th√°i cho ph√©p x√≥a
    if (!['REJECTED', 'CANCELLED'].includes(request.status)) {
      throw new Error('Customer can only delete rejected/cancelled requests');
    }
    
    await this.repo.update(id, { customer_deleted_at: new Date() });
  }
  
  // Audit log
  await audit(actor._id, 'REQUEST.DELETED', 'REQUEST', id, { scope });
  
  return { ok: true, id, scope, deleted_at: new Date() };
}

// Restore theo scope
async restore(id: string, scope: 'depot' | 'customer', actor: User) {
  const request = await this.repo.findById(id);
  if (!request) throw new Error('Request not found');
  
  if (scope === 'depot') {
    if (!['SaleAdmin', 'Accountant', 'SystemAdmin'].includes(actor.role)) {
      throw new Error('Unauthorized for depot scope');
    }
    await this.repo.update(id, { depot_deleted_at: null });
  } else {
    if (!['CustomerAdmin', 'CustomerUser'].includes(actor.role)) {
      throw new Error('Unauthorized for customer scope');
    }
    if (request.tenant_id !== actor.tenant_id) {
      throw new Error('Request does not belong to your organization');
    }
    await this.repo.update(id, { customer_deleted_at: null });
  }
  
  // Audit log
  await audit(actor._id, 'REQUEST.RESTORED', 'REQUEST', id, { scope });
  
  return { ok: true, id, scope, restored_at: new Date() };
}
```

##### Repository Layer (RequestRepository.ts)
```typescript
// List requests v·ªõi filter theo scope
async listForDepot(query: ListQuery) {
  return this.prisma.serviceRequest.findMany({
    where: {
      depot_deleted_at: null, // Ch·ªâ l·∫•y ch∆∞a b·ªã x√≥a b·ªüi depot
      ...this.buildWhereClause(query)
    },
    include: {
      documents: true,
      chatRoom: true
    },
    orderBy: { createdAt: 'desc' }
  });
}

async listForCustomer(tenantId: string, query: ListQuery) {
  return this.prisma.serviceRequest.findMany({
    where: {
      tenant_id: tenantId,
      customer_deleted_at: null, // Ch·ªâ l·∫•y ch∆∞a b·ªã x√≥a b·ªüi customer
      ...this.buildWhereClause(query)
    },
    include: {
      documents: true,
      chatRoom: true
    },
    orderBy: { createdAt: 'desc' }
  });
}

// Update v·ªõi soft-delete fields
async update(id: string, data: any) {
  return this.prisma.serviceRequest.update({
    where: { id },
    data: {
      ...data,
      updatedAt: new Date()
    }
  });
}
```

##### Controller Layer (RequestController.ts)
```typescript
// Reject request
async rejectRequest(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const { reason } = req.body;
    const actor = req.user!;
    
    const result = await this.service.rejectRequest(id, reason, actor);
    return res.json(result);
  } catch (error: any) {
    return res.status(400).json({ message: error.message });
  }
}

// Soft-delete theo scope
async softDelete(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const { scope } = req.query;
    const actor = req.user!;
    
    if (!scope || !['depot', 'customer'].includes(scope as string)) {
      return res.status(400).json({ message: 'Invalid scope parameter' });
    }
    
    const result = await this.service.softDelete(id, scope as 'depot' | 'customer', actor);
    return res.json(result);
  } catch (error: any) {
    return res.status(400).json({ message: error.message });
  }
}

// Restore theo scope
async restore(req: Request, res: Response) {
  try {
    const { id } = req.params;
    const { scope } = req.query;
    const actor = req.user!;
    
    if (!scope || !['depot', 'customer'].includes(scope as string)) {
      return res.status(400).json({ message: 'Invalid scope parameter' });
    }
    
    const result = await this.service.restore(id, scope as 'depot' | 'customer', actor);
    return res.json(result);
  } catch (error: any) {
    return res.status(400).json({ message: error.message });
  }
}
```

##### Routes (RequestRoutes.ts)
```typescript
// Soft-delete routes
router.patch('/:id/reject', authenticate, requireRoles(['SaleAdmin', 'Accountant', 'SystemAdmin']), controller.rejectRequest);
router.delete('/:id', authenticate, controller.softDelete);
router.post('/:id/restore', authenticate, controller.restore);
```

#### 6.3.6) Frontend Integration

##### RequestTable Component
```typescript
// Th√™m action buttons cho soft-delete
const getActionButtons = (request: Request, userRole: string) => {
  const buttons = [];
  
  // N√∫t Reject (ch·ªâ cho Kho)
  if (['SaleAdmin', 'Accountant', 'SystemAdmin'].includes(userRole)) {
    if (['PENDING', 'APPROVED', 'IN_PROGRESS'].includes(request.status)) {
      buttons.push(
        <button
          key="reject"
          onClick={() => handleReject(request.id)}
          className="bg-red-500 text-white px-3 py-1 rounded text-sm hover:bg-red-600"
        >
          ‚ùå T·ª´ ch·ªëi
        </button>
      );
    }
  }
  
  // N√∫t Delete theo scope
  if (['SaleAdmin', 'Accountant', 'SystemAdmin'].includes(userRole)) {
    // Kho c√≥ th·ªÉ x√≥a REJECTED, CANCELLED, COMPLETED
    if (['REJECTED', 'CANCELLED', 'COMPLETED'].includes(request.status)) {
      buttons.push(
        <button
          key="delete-depot"
          onClick={() => handleDelete(request.id, 'depot')}
          className="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
        >
          üóëÔ∏è X√≥a kh·ªèi Kho
        </button>
      );
    }
  }
  
  if (['CustomerAdmin', 'CustomerUser'].includes(userRole)) {
    // Kh√°ch h√†ng c√≥ th·ªÉ x√≥a REJECTED, CANCELLED
    if (['REJECTED', 'CANCELLED'].includes(request.status)) {
      buttons.push(
        <button
          key="delete-customer"
          onClick={() => handleDelete(request.id, 'customer')}
          className="bg-gray-500 text-white px-3 py-1 rounded text-sm hover:bg-gray-600"
        >
          üóëÔ∏è X√≥a kh·ªèi danh s√°ch
        </button>
      );
    }
  }
  
  return buttons;
};

// Handler functions
const handleReject = async (requestId: string) => {
  const reason = prompt('Nh·∫≠p l√Ω do t·ª´ ch·ªëi:');
  if (!reason) return;
  
  try {
    await axios.patch(`/api/requests/${requestId}/reject`, { reason });
    toast.success('ƒê√£ t·ª´ ch·ªëi ƒë∆°n h√†ng');
    mutate(); // Refresh data
  } catch (error) {
    toast.error('L·ªói khi t·ª´ ch·ªëi ƒë∆°n h√†ng');
  }
};

const handleDelete = async (requestId: string, scope: 'depot' | 'customer') => {
  const confirmMessage = scope === 'depot' 
    ? 'X√≥a kh·ªèi danh s√°ch Kho? (ƒê∆°n h√†ng v·∫´n hi·ªÉn th·ªã b√™n Kh√°ch h√†ng)'
    : 'X√≥a kh·ªèi danh s√°ch c·ªßa b·∫°n?';
    
  if (!confirm(confirmMessage)) return;
  
  try {
    await axios.delete(`/api/requests/${requestId}?scope=${scope}`);
    toast.success(`ƒê√£ x√≥a kh·ªèi danh s√°ch ${scope === 'depot' ? 'Kho' : 'c·ªßa b·∫°n'}`);
    mutate(); // Refresh data
  } catch (error) {
    toast.error('L·ªói khi x√≥a ƒë∆°n h√†ng');
  }
};
```

#### 6.3.7) Test Cases
```typescript
// Unit tests cho soft-delete functionality
describe('Soft-Delete Functionality', () => {
  test('Depot can reject pending request', async () => {
    const request = await createTestRequest({ status: 'PENDING' });
    const depotUser = await createTestUser({ role: 'SaleAdmin' });
    
    const result = await requestService.rejectRequest(request.id, 'Test reason', depotUser);
    
    expect(result.status).toBe('REJECTED');
    expect(result.rejected_reason).toBe('Test reason');
    expect(result.rejected_by).toBe(depotUser._id);
  });
  
  test('Depot can soft-delete rejected request', async () => {
    const request = await createTestRequest({ status: 'REJECTED' });
    const depotUser = await createTestUser({ role: 'SaleAdmin' });
    
    const result = await requestService.softDelete(request.id, 'depot', depotUser);
    
    expect(result.ok).toBe(true);
    expect(result.scope).toBe('depot');
    
    // Verify request is hidden from depot list
    const depotList = await requestService.listForDepot({});
    expect(depotList.find(r => r.id === request.id)).toBeUndefined();
  });
  
  test('Customer cannot delete pending request', async () => {
    const request = await createTestRequest({ status: 'PENDING' });
    const customerUser = await createTestUser({ role: 'CustomerUser' });
    
    await expect(
      requestService.softDelete(request.id, 'customer', customerUser)
    ).rejects.toThrow('Customer can only delete rejected/cancelled requests');
  });
});
```

### 6.1.1) Document Upload & Viewer System

#### 6.1.1.1) Overview
H·ªá th·ªëng h·ªó tr·ª£ upload v√† xem ch·ª©ng t·ª´ cho t·ª´ng request:
- **Upload**: H·ªó tr·ª£ file ·∫£nh (jpg, png, gif) v√† PDF khi t·∫°o request
- **Storage**: Files ƒë∆∞·ª£c l∆∞u t·∫°i `D:\container\container2\backend\uploads`
- **Viewer**: Modal popup ƒë·ªÉ xem ·∫£nh tr·ª±c ti·∫øp ho·∫∑c download PDF
- **Public Access**: Documents c√≥ th·ªÉ xem m√† kh√¥ng c·∫ßn authentication

#### 6.1.1.2) File Upload Process
```typescript
// Frontend: Upload files khi t·∫°o request
const handleFileUpload = async (files: FileList) => {
  const formData = new FormData();
  Array.from(files).forEach(file => {
    formData.append('documents', file);
  });
  
  try {
    const response = await axios.post('/api/requests', formData, {
      headers: { 'Content-Type': 'multipart/form-data' }
    });
  } catch (error) {
    console.error('Upload failed:', error);
  }
};
```

#### 6.1.1.3) Backend File Processing
```typescript
// RequestService.ts - X·ª≠ l√Ω upload files
async createRequest(data: CreateRequestDto, files: Express.Multer.File[], actor: User) {
  // T·∫°o request
  const request = await this.repo.create({
    ...data,
    created_by: actor._id,
    tenant_id: actor.tenant_id
  });

  // X·ª≠ l√Ω upload files
  if (files && files.length > 0) {
    for (const file of files) {
      const fileName = `${Date.now()}-${file.originalname}`;
      const filePath = path.join(uploadDir, fileName);
      
      // L∆∞u file
      await fs.promises.writeFile(filePath, file.buffer);
      
      // T·∫°o record trong database
      await this.docRepo.createDoc({
        request_id: request.id,
        file_name: file.originalname,
        storage_key: fileName,
        file_type: file.mimetype,
        file_size: file.size,
        uploader_id: actor._id
      });
    }
  }

  return request;
}
```

#### 6.1.1.4) Document Viewer Implementation

##### Frontend Component (DocumentViewer.tsx)
```typescript
interface DocumentViewerProps {
  documents: DocumentFile[];
  onClose: () => void;
}

export default function DocumentViewer({ documents, onClose }: DocumentViewerProps) {
  const [selectedDoc, setSelectedDoc] = useState<DocumentFile | null>(null);

  const handleDocumentClick = (doc: DocumentFile) => {
    setSelectedDoc(doc);
  };

  const isImage = (mimeType: string) => {
    return mimeType.startsWith('image/');
  };

  return (
    <div className="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
      <div className="bg-white rounded-lg p-6 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
        <div className="flex justify-between items-center mb-4">
          <h2 className="text-xl font-bold">Ch·ª©ng t·ª´</h2>
          <button onClick={onClose} className="text-gray-500 hover:text-gray-700">
            ‚úï
          </button>
        </div>

        {/* Document List */}
        <div className="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
          {documents.map((doc) => (
            <div
              key={doc.id}
              onClick={() => handleDocumentClick(doc)}
              className="border rounded-lg p-3 cursor-pointer hover:bg-gray-50"
            >
              <div className="text-center">
                {isImage(doc.file_type) ? (
                  <img
                    src={`/api/requests/documents/${doc.storage_key}`}
                    alt={doc.file_name}
                    className="w-full h-24 object-cover rounded mb-2"
                  />
                ) : (
                  <div className="w-full h-24 bg-gray-100 flex items-center justify-center rounded mb-2">
                    üìÑ PDF
                  </div>
                )}
                <p className="text-sm text-gray-600 truncate">{doc.file_name}</p>
              </div>
            </div>
          ))}
        </div>

        {/* Document Preview Modal */}
        {selectedDoc && (
          <div className="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-60">
            <div className="bg-white rounded-lg p-4 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
              <div className="flex justify-between items-center mb-4">
                <h3 className="text-lg font-semibold">{selectedDoc.file_name}</h3>
                <button onClick={() => setSelectedDoc(null)} className="text-gray-500 hover:text-gray-700">
                  ‚úï
                </button>
              </div>
              
              {isImage(selectedDoc.file_type) ? (
                <img
                  src={`/api/requests/documents/${selectedDoc.storage_key}`}
                  alt={selectedDoc.file_name}
                  className="w-full h-auto max-h-[70vh] object-contain"
                />
              ) : (
                <div className="text-center py-8">
                  <p className="text-gray-600 mb-4">PDF Document</p>
                  <a
                    href={`/api/requests/documents/${selectedDoc.storage_key}`}
                    download={selectedDoc.file_name}
                    className="bg-blue-500 text-white px-4 py-2 rounded hover:bg-blue-600"
                  >
                    üì• Download PDF
                  </a>
                </div>
              )}
            </div>
          </div>
        )}
      </div>
    </div>
  );
}
```

#### 6.1.1.5) Backend Document Serving

##### Document Routes (DocumentRoutes.ts)
```typescript
import express from 'express';
import path from 'path';
import fs from 'fs';

const router = express.Router();

// Serve documents without authentication
router.get('/:filename', async (req, res) => {
  try {
    const { filename } = req.params;
    const filePath = path.join(process.cwd(), 'uploads', filename);
    
    // Ki·ªÉm tra file t·ªìn t·∫°i
    if (!fs.existsSync(filePath)) {
      return res.status(404).json({ message: 'File not found' });
    }
    
    // L·∫•y file stats
    const stats = fs.statSync(filePath);
    
    // Set headers
    res.setHeader('Content-Length', stats.size);
    res.setHeader('Content-Type', getMimeType(filename));
    res.setHeader('Content-Disposition', `inline; filename="${filename}"`);
    
    // Stream file
    const fileStream = fs.createReadStream(filePath);
    fileStream.pipe(res);
  } catch (error) {
    console.error('Error serving document:', error);
    res.status(500).json({ message: 'Internal server error' });
  }
});

function getMimeType(filename: string): string {
  const ext = path.extname(filename).toLowerCase();
  const mimeTypes: Record<string, string> = {
    '.jpg': 'image/jpeg',
    '.jpeg': 'image/jpeg',
    '.png': 'image/png',
    '.gif': 'image/gif',
    '.pdf': 'application/pdf'
  };
  return mimeTypes[ext] || 'application/octet-stream';
}

export default router;
```

##### Main.ts Configuration
```typescript
// Serve documents without authentication (public access)
app.use('/requests/documents', documentRoutes);

// All other request routes require authentication
app.use('/requests', authenticate, requestRoutes);
```

#### 6.1.1.6) Database Schema
```sql
-- Document files table
CREATE TABLE document_files (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  request_id UUID NOT NULL REFERENCES service_requests(id) ON DELETE CASCADE,
  file_name VARCHAR(255) NOT NULL,
  storage_key VARCHAR(255) NOT NULL UNIQUE,
  file_type VARCHAR(100) NOT NULL,
  file_size INTEGER NOT NULL,
  uploader_id UUID NOT NULL REFERENCES users(id),
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Indexes
CREATE INDEX idx_document_files_request_id ON document_files(request_id);
CREATE INDEX idx_document_files_storage_key ON document_files(storage_key);
```

#### 6.1.1.7) Multer Configuration
```typescript
// multer.ts
import multer from 'multer';
import path from 'path';

const storage = multer.memoryStorage();

const fileFilter = (req: any, file: Express.Multer.File, cb: multer.FileFilterCallback) => {
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
  const maxSize = 10 * 1024 * 1024; // 10MB
  
  if (!allowedTypes.includes(file.mimetype)) {
    return cb(new Error('Invalid file type. Only images and PDFs are allowed.'));
  }
  
  if (file.size > maxSize) {
    return cb(new Error('File too large. Maximum size is 10MB.'));
  }
  
  cb(null, true);
};

export const upload = multer({
  storage,
  fileFilter,
  limits: {
    fileSize: 10 * 1024 * 1024, // 10MB
    files: 5 // Maximum 5 files per request
  }
});
```

#### 6.1.1.8) Request Table Integration
```typescript
// RequestTable.tsx - Th√™m c·ªôt Documents
const columns = [
  // ... other columns
  {
    key: 'documents',
    label: 'Ch·ª©ng t·ª´',
    render: (item: Request) => (
      <div className="flex gap-1">
        {item.documents && item.documents.length > 0 ? (
          <button
            onClick={() => setSelectedRequestId(item.id)}
            className="bg-blue-500 text-white px-2 py-1 rounded text-xs hover:bg-blue-600"
          >
            üìÑ Xem ({item.documents.length})
          </button>
        ) : (
          <span className="text-gray-400 text-xs">Kh√¥ng c√≥</span>
        )}
      </div>
    )
  }
];

// Document viewer modal
{selectedRequestId && (
  <DocumentViewer
    documents={data?.find((r: any) => r.id === selectedRequestId)?.documents || []}
    onClose={() => setSelectedRequestId(null)}
  />
)}
```

#### 6.1.1.9) Error Handling & Validation
```typescript
// Validation middleware
const validateFileUpload = (req: Request, res: Response, next: NextFunction) => {
  if (!req.files || req.files.length === 0) {
    return res.status(400).json({ message: 'No files uploaded' });
  }
  
  const files = Array.isArray(req.files) ? req.files : [req.files];
  const allowedTypes = ['image/jpeg', 'image/png', 'image/gif', 'application/pdf'];
  const maxSize = 10 * 1024 * 1024; // 10MB
  
  for (const file of files) {
    if (!allowedTypes.includes(file.mimetype)) {
      return res.status(400).json({ 
        message: `Invalid file type: ${file.originalname}. Only images and PDFs are allowed.` 
      });
    }
    
    if (file.size > maxSize) {
      return res.status(400).json({ 
        message: `File too large: ${file.originalname}. Maximum size is 10MB.` 
      });
    }
  }
  
  next();
};
```

#### 6.1.1.10) Security Considerations
- **File Type Validation**: Ch·ªâ cho ph√©p images v√† PDFs
- **File Size Limits**: Gi·ªõi h·∫°n 10MB per file
- **Storage Security**: Files ƒë∆∞·ª£c l∆∞u ngo√†i web root
- **Access Control**: Documents c√≥ th·ªÉ xem public nh∆∞ng upload c·∫ßn authentication
- **File Naming**: S·ª≠ d·ª•ng timestamp ƒë·ªÉ tr√°nh conflict
- **Error Handling**: Proper error messages cho invalid files

#### 6.1.1.11) S·ª≠a l·ªói Authentication cho Document Viewer
- **V·∫•n ƒë·ªÅ**: API `/requests/documents/:filename` b·ªã l·ªói "Unauthorized" do middleware `authenticate` ƒë∆∞·ª£c √°p d·ª•ng cho t·∫•t c·∫£ routes `/requests/*`
- **Gi·∫£i ph√°p**: 
  - T·∫°o router ri√™ng `DocumentRoutes.ts` cho documents kh√¥ng c·∫ßn authentication
  - C·∫•u h√¨nh trong `main.ts`: 
    ```typescript
    // Serve documents without authentication (public access)
    app.use('/requests/documents', documentRoutes);
    // All other request routes require authentication
    app.use('/requests', authenticate, requestRoutes);
    ```
  - X√≥a route `/documents/:filename` kh·ªèi `RequestRoutes.ts` ƒë·ªÉ tr√°nh conflict
- **K·∫øt qu·∫£**: Documents c√≥ th·ªÉ ƒë∆∞·ª£c xem tr·ª±c ti·∫øp m√† kh√¥ng c·∫ßn ƒëƒÉng nh·∫≠p

## 7) FE g·ª£i √Ω
- Trang kh√°ch h√†ng (Customer*): form t·∫°o y√™u c·∫ßu + list; filter theo tr·∫°ng th√°i.
- Trang depot (SaleAdmin): b·∫£ng requests v·ªõi action nh·∫≠n/t·ª´ ch·ªëi; tab docs; n√∫t ‚ÄúG·ª≠i y√™u c·∫ßu thanh to√°n‚Äù.

## 8) B·∫£n ƒë·ªì m√£ ngu·ªìn Module 3
- DTO: `modules/requests/dto/RequestDtos.ts`
- Repository: `modules/requests/repository/RequestRepository.ts`
- Service: `modules/requests/service/RequestService.ts`
- Controller: `modules/requests/controller/RequestController.ts`
- Routes: `modules/requests/controller/RequestRoutes.ts`
- Document Routes: `modules/requests/controller/DocumentRoutes.ts` (public access)
- Prisma: `prisma/schema.prisma` (ServiceRequest, DocumentFile, PaymentRequest)

### 8.1) Appointment System (Module 3.2)
- DTO: `modules/requests/dto/AppointmentDtos.ts`
- Service: `modules/requests/service/AppointmentService.ts`
- Controller: `modules/requests/controller/AppointmentController.ts`
- Routes: `modules/requests/controller/AppointmentRoutes.ts`
- Frontend: `frontend/components/AppointmentModal.tsx`

### 8.2) Attachment System (Module 3.3)
- DTO: `modules/requests/dto/AttachmentDtos.ts`
- Repository: `modules/requests/repository/AttachmentRepository.ts`
- Service: `modules/requests/service/AttachmentService.ts`
- Controller: `modules/requests/controller/AttachmentController.ts`
- Routes: `modules/requests/controller/AttachmentRoutes.ts`
- Frontend: `frontend/components/UploadModal.tsx`

### 8.1) Chat System (Module 3.1)
- DTO: `modules/chat/dto/ChatDtos.ts`
- Repository: `modules/chat/repository/ChatRepository.ts`
- Service: `modules/chat/service/ChatService.ts`
- Controller: `modules/chat/controller/ChatController.ts`
- Routes: `modules/chat/controller/ChatRoutes.ts`
- WebSocket: `modules/chat/websocket/ChatWebSocket.ts`
- Prisma: `prisma/schema.prisma` (ChatRoom, ChatMessage)

## 9) TODO ti·∫øp theo
- Notification service (email/webpush) khi t·∫°o/nh·∫≠n/t·ª´ ch·ªëi.
- **‚úÖ Viewer file**: ƒê√£ implement modal xem ·∫£nh tr·ª±c ti·∫øp + download link cho PDF.
- **‚úÖ S·ª≠a l·ªói authentication**: ƒê√£ t·∫°o DocumentRoutes ri√™ng ƒë·ªÉ serve files kh√¥ng c·∫ßn authentication.
- **‚úÖ Soft-delete theo scope**: ƒê√£ implement t√≠nh nƒÉng x√≥a/·∫©n request theo ph·∫°m vi ng∆∞·ªùi d√πng (depot/customer).
- **‚úÖ Chat System**: ƒê√£ implement box chat theo ƒë∆°n h√†ng v·ªõi WebSocket real-time.
- **‚úÖ Appointment System**: ƒê√£ implement t√≠nh nƒÉng ti·∫øp nh·∫≠n y√™u c·∫ßu v·ªõi l·ªãch h·∫πn v√† m·ªü chat.
- **‚úÖ Attachment System**: ƒê√£ implement upload/download ch·ª©ng t·ª´ cho kh√°ch h√†ng v√† depot.
- Accountant x·ª≠ l√Ω PaymentRequest (RECEIVED/PAID/REJECTED) + xu·∫•t h√≥a ƒë∆°n.
- Reuse COS: th√™m endpoint redirect v·ªõi prefill.

## 10) References & Li√™n k·∫øt module

### 10.1. Li√™n k·∫øt v·ªõi Module 1 ‚Äî Qu·∫£n l√Ω Ng∆∞·ªùi d√πng & ƒê·ªëi t√°c
- ServiceRequest l∆∞u `tenant_id` ƒë·ªÉ √°p scope theo kh√°ch h√†ng.
- Ng∆∞·ªùi t·∫°o/duy·ªát request l√† user trong Module 1: `created_by` ‚Üî user_id.
- RBAC k·∫ø th·ª´a t·ª´ Module 1 (vai tr√≤: CustomerAdmin/CustomerUser, SaleAdmin, Accountant).
- Khi SaleAdmin t·∫°o user kh√°ch ho·∫∑c CustomerAdmin m·ªùi user, h·ªç c√≥ th·ªÉ truy c·∫≠p Module 3 theo scope tenant.

### 10.2. Li√™n k·∫øt v·ªõi Module 2 ‚Äî Auth & Account
- JWT ch·ª©a `role`, `tenant_id` ƒë∆∞·ª£c s·ª≠ d·ª•ng ƒë·ªÉ filter v√† ki·ªÉm tra quy·ªÅn cho t·∫•t c·∫£ API c·ªßa Module 3.
- Audit log d√πng middleware chung `shared/middlewares/audit.ts` nh∆∞ Module 2.
- Ng∆∞·ªùi d√πng ƒëƒÉng nh·∫≠p/ƒë·ªïi m·∫≠t kh·∫©u/accept-invite ·ªü Module 2 tr∆∞·ªõc khi thao t√°c y√™u c·∫ßu d·ªãch v·ª•.

### 10.3. Li√™n k·∫øt Module 4 ‚Äî Gate Management
- Gate IN/OUT s·ª≠ d·ª•ng c√°c tr·∫°ng th√°i `IN_YARD` v√† `LEFT_YARD` ƒë∆∞·ª£c m√¥ t·∫£ ·ªü Module 4.

### 10.4. B·∫£ng ph√¢n quy·ªÅn (RBAC) t√≥m t·∫Øt cho Module 3

| T√°c v·ª•                                    | CustomerAdmin | CustomerUser | SaleAdmin | Accountant |
|-------------------------------------------|---------------|--------------|----------:|-----------:|
| T·∫°o y√™u c·∫ßu (POST /requests)              | ‚úÖ (tenant)    | ‚úÖ (tenant)   | ‚úÖ         | ‚ùå          |
| Upload ch·ª©ng t·ª´ khi t·∫°o request           | ‚úÖ (tenant)    | ‚úÖ (tenant)   | ‚úÖ         | ‚ùå          |
| Danh s√°ch y√™u c·∫ßu (GET /requests)         | ‚úÖ (tenant)    | ‚úÖ (tenant)   | ‚úÖ         | ‚úÖ          |
| C·∫≠p nh·∫≠t tr·∫°ng th√°i (PATCH /:id/status)   | ‚ùå             | ‚ùå            | ‚úÖ         | ‚ùå          |
| Upload EIR/LOLO (POST /:id/docs)          | ‚ùå             | ‚ùå            | ‚úÖ         | ‚ùå          |
| Upload INVOICE (POST /:id/docs)           | ‚ùå             | ‚ùå            | ‚ùå         | ‚úÖ          |
| Xem ch·ª©ng t·ª´ (GET /:id/docs)              | ‚úÖ (tenant)    | ‚úÖ (tenant)   | ‚úÖ         | ‚úÖ          |
| X√≥a ch·ª©ng t·ª´ (DELETE /:id/docs/:docId)    | ‚ùå (tr·ª´ uploader) | ‚ùå         | ‚úÖ         | ‚úÖ          |
| G·ª≠i y√™u c·∫ßu thanh to√°n (POST /:id/payment-request) | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| Reject request (PATCH /:id/reject) | ‚ùå | ‚ùå | ‚úÖ | ‚ùå |
| Soft-delete request (DELETE /:id?scope=depot) | ‚ùå | ‚ùå | ‚úÖ | ‚úÖ |
| Soft-delete request (DELETE /:id?scope=customer) | ‚úÖ | ‚úÖ | ‚ùå | ‚ùå |
| Restore request (POST /:id/restore) | ‚úÖ | ‚úÖ | ‚úÖ | ‚úÖ |
| Chat access (GET /chat/request/:id) | ‚úÖ (tenant) | ‚úÖ (tenant) | ‚úÖ | ‚úÖ |
| Send message (POST /chat/:id/messages) | ‚úÖ (approved) | ‚úÖ (approved) | ‚úÖ (approved) | ‚úÖ (approved) |
| Upload documents (POST /requests with files) | ‚úÖ (tenant) | ‚úÖ (tenant) | ‚úÖ | ‚ùå |
| View documents (GET /requests/documents/:filename) | ‚úÖ (public) | ‚úÖ (public) | ‚úÖ (public) | ‚úÖ (public) |
| Delete documents (DELETE /:id/documents/:docId) | ‚ùå (tr·ª´ uploader) | ‚ùå (tr·ª´ uploader) | ‚úÖ | ‚úÖ |

Ghi ch√∫:
- ‚Äú(tenant)‚Äù nghƒ©a l√† ch·ªâ trong tenant c·ªßa user, √°p d·ª•ng qua `tenant_id` trong JWT.
- X√≥a ch·ª©ng t·ª´: ng∆∞·ªùi upload x√≥a ƒë∆∞·ª£c; ho·∫∑c vai tr√≤ cao h∆°n (SystemAdmin/BusinessAdmin/SaleAdmin/Accountant).
