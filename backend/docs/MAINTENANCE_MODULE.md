# MAINTENANCE MODULE - BACKEND DOCUMENTATION

## üìã T·ªïng quan

Module b·∫£o tr√¨ (Maintenance) qu·∫£n l√Ω to√†n b·ªô quy tr√¨nh ki·ªÉm tra, s·ª≠a ch·ªØa container v√† qu·∫£n l√Ω t·ªìn kho ph·ª• t√πng. Module n√†y t√≠ch h·ª£p ch·∫∑t ch·∫Ω v·ªõi ServiceRequest ƒë·ªÉ ƒë·ªìng b·ªô tr·∫°ng th√°i gi·ªØa y√™u c·∫ßu v√† phi·∫øu s·ª≠a ch·ªØa.

## üèóÔ∏è Ki·∫øn tr√∫c

### C·∫•u tr√∫c th∆∞ m·ª•c
```
modules/maintenance/
‚îú‚îÄ‚îÄ controller/          # X·ª≠ l√Ω HTTP requests
‚îú‚îÄ‚îÄ service/            # Logic nghi·ªáp v·ª•
‚îú‚îÄ‚îÄ dto/               # Validation schemas
‚îú‚îÄ‚îÄ routes/            # ƒê·ªãnh nghƒ©a API routes
‚îî‚îÄ‚îÄ docs/              # T√†i li·ªáu module
```

### C√°c th√†nh ph·∫ßn ch√≠nh
- **MaintenanceController**: X·ª≠ l√Ω HTTP requests v√† responses
- **MaintenanceService**: Logic nghi·ªáp v·ª• v√† t∆∞∆°ng t√°c database
- **MaintenanceRoutes**: ƒê·ªãnh nghƒ©a API endpoints
- **MaintenanceDtos**: Validation schemas cho input/output

## üîå API Endpoints

### 1. Qu·∫£n l√Ω phi·∫øu s·ª≠a ch·ªØa (Repair Tickets)

#### `POST /maintenance/repairs`
- **M√¥ t·∫£**: T·∫°o phi·∫øu s·ª≠a ch·ªØa m·ªõi
- **Body**: `createRepairSchema`
- **Response**: Phi·∫øu s·ª≠a ch·ªØa ƒë√£ t·∫°o

#### `GET /maintenance/repairs`
- **M√¥ t·∫£**: L·∫•y danh s√°ch phi·∫øu s·ª≠a ch·ªØa
- **Query**: `listRepairsSchema` (status, container_no)
- **Response**: Danh s√°ch phi·∫øu s·ª≠a ch·ªØa

#### `GET /maintenance/repairs/:id`
- **M√¥ t·∫£**: L·∫•y chi ti·∫øt phi·∫øu s·ª≠a ch·ªØa
- **Response**: Th√¥ng tin chi ti·∫øt phi·∫øu s·ª≠a ch·ªØa

#### `PATCH /maintenance/repairs/:id/status`
- **M√¥ t·∫£**: C·∫≠p nh·∫≠t tr·∫°ng th√°i phi·∫øu s·ª≠a ch·ªØa
- **Body**: `updateRepairDetailsSchema`
- **Response**: Phi·∫øu s·ª≠a ch·ªØa ƒë√£ c·∫≠p nh·∫≠t

#### `PATCH /maintenance/repairs/:id/details`
- **M√¥ t·∫£**: C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt s·ª≠a ch·ªØa
- **Body**: `updateRepairDetailsSchema`

#### `POST /maintenance/repairs/:id/confirmation-request`
- **M√¥ t·∫£**: G·ª≠i y√™u c·∫ßu x√°c nh·∫≠n cho Depot (c·∫≠p nh·∫≠t viewquote = 1)
- **Authorization**: SaleAdmin, SystemAdmin
- **Body**: None
- **Response**: `{ success: true, message: "..." }`

#### `POST /maintenance/repairs/:id/complete-check`
- **M√¥ t·∫£**: Ho√†n th√†nh ki·ªÉm tra container
- **Body**: `completeCheckSchema`
- **Response**: K·∫øt qu·∫£ ki·ªÉm tra

#### `POST /maintenance/repairs/:id/approve`
- **M√¥ t·∫£**: Ch·∫•p nh·∫≠n phi·∫øu s·ª≠a ch·ªØa
- **Body**: `approveSchema`
- **Response**: Phi·∫øu s·ª≠a ch·ªØa ƒë√£ ƒë∆∞·ª£c ch·∫•p nh·∫≠n

#### `POST /maintenance/repairs/:id/reject`
- **M√¥ t·∫£**: T·ª´ ch·ªëi phi·∫øu s·ª≠a ch·ªØa
- **Body**: `rejectSchema`
- **Response**: Phi·∫øu s·ª≠a ch·ªØa ƒë√£ b·ªã t·ª´ ch·ªëi

### 2. Qu·∫£n l√Ω t·ªìn kho (Inventory)

#### `GET /maintenance/inventory`
- **M√¥ t·∫£**: L·∫•y danh s√°ch ph·ª• t√πng t·ªìn kho
- **Response**: Danh s√°ch ph·ª• t√πng

#### `POST /maintenance/inventory`
- **M√¥ t·∫£**: T·∫°o ph·ª• t√πng m·ªõi
- **Body**: `createInventorySchema`
- **Response**: Ph·ª• t√πng ƒë√£ t·∫°o

#### `GET /maintenance/inventory/:id`
- **M√¥ t·∫£**: L·∫•y chi ti·∫øt ph·ª• t√πng
- **Response**: Th√¥ng tin chi ti·∫øt ph·ª• t√πng

#### `PUT /maintenance/inventory/:id`
- **M√¥ t·∫£**: C·∫≠p nh·∫≠t th√¥ng tin ph·ª• t√πng
- **Body**: `updateInventorySchema`
- **Response**: Ph·ª• t√πng ƒë√£ c·∫≠p nh·∫≠t

## üóÑÔ∏è Database Models

### RepairTicket
```prisma
model RepairTicket {
  id                    String      @id @default(cuid())
  code                  String      @unique
  container_no          String?
  equipment_id          String?
  problem_description   String
  estimated_cost        Decimal     @default(0)
  status                RepairStatus @default(CHECKING)
  manager_comment       String?
  labor_cost            Decimal?
  selected_parts        String?
  technician_notes      String?
  repair_notes          String?
  viewquote             Int         @default(0)  // 0: Ch·ªâ Maintenance xem, 1: Depot xem, 2: Customer xem
  created_at            DateTime    @default(now())
  updated_at            DateTime    @updatedAt
  created_by            String
  updated_by            String?
  
  items                 RepairItem[]
}
```

### InventoryItem
```prisma
model InventoryItem {
  id            String   @id @default(cuid())
  name          String
  uom           String
  qty_on_hand  Int      @default(0)
  reorder_point Int     @default(0)
  price         Decimal  @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  created_by    String
  updated_by    String?
}
```

### RepairStatus Enum
```prisma
enum RepairStatus {
  CHECKING         // ƒêang ki·ªÉm tra
  PENDING_ACCEPT   // Ch·ªù ch·∫•p nh·∫≠n
  REPAIRING        // ƒêang s·ª≠a ch·ªØa
  CHECKED          // ƒê√£ ki·ªÉm tra
  REJECTED         // ƒê√£ t·ª´ ch·ªëi
}
```

## üîÑ Quy tr√¨nh nghi·ªáp v·ª•

### 1. Quy tr√¨nh ki·ªÉm tra container
```
GATE_IN ‚Üí CHECKING ‚Üí CHECKED/REJECTED
```

**Chi ti·∫øt:**
- Container c√≥ tr·∫°ng th√°i `GATE_IN` ƒë∆∞·ª£c ch·ªçn ƒë·ªÉ ki·ªÉm tra
- Khi b·∫•m "B·∫Øt ƒë·∫ßu ki·ªÉm tra":
  - `ServiceRequest.status` ‚Üí `CHECKING`
  - T·∫°o `RepairTicket` v·ªõi `status = CHECKING`
- K·∫øt qu·∫£ ki·ªÉm tra:
  - **ƒê·∫°t chu·∫©n**: `RepairTicket.status` ‚Üí `CHECKED`, `ServiceRequest.status` ‚Üí `CHECKED`
  - **Kh√¥ng ƒë·∫°t chu·∫©n**: Gi·ªØ nguy√™n `CHECKING`, hi·ªÉn th·ªã 2 option:
    - "C√≥ th·ªÉ s·ª≠a ch·ªØa": M·ªü popup h√≥a ƒë∆°n s·ª≠a ch·ªØa
    - "Kh√¥ng th·ªÉ s·ª≠a ch·ªØa": `RepairTicket.status` ‚Üí `REJECTED`, `ServiceRequest.status` ‚Üí `REJECTED`

### 2. Quy tr√¨nh s·ª≠a ch·ªØa
```
CHECKING ‚Üí REPAIRING ‚Üí CHECKED
```

**Chi ti·∫øt:**
- Khi ch·ªçn "C√≥ th·ªÉ s·ª≠a ch·ªØa":
  - M·ªü popup h√≥a ƒë∆°n s·ª≠a ch·ªØa
  - Ch·ªçn ph·ª• t√πng t·ª´ inventory
  - Nh·∫≠p chi ph√≠ c√¥ng s·ª≠a ch·ªØa
  - T√≠nh to√°n chi ph√≠ ∆∞·ªõc t√≠nh = gi√° ph·ª• t√πng + c√¥ng s·ª≠a ch·ªØa
  - C·∫≠p nh·∫≠t `RepairTicket` v·ªõi th√¥ng tin chi ti·∫øt

## üíª Logic nghi·ªáp v·ª• ch√≠nh

### MaintenanceService

#### `createRepair(actor, payload)`
- T·∫°o phi·∫øu s·ª≠a ch·ªØa v·ªõi `status = CHECKING`
- T·ª± ƒë·ªông t·∫°o `RepairItem` n·∫øu c√≥

#### `updateRepairStatus(actor, id, status, manager_comment)`
- C·∫≠p nh·∫≠t tr·∫°ng th√°i phi·∫øu s·ª≠a ch·ªØa
- ƒê·ªìng b·ªô tr·∫°ng th√°i v·ªõi `ServiceRequest` n·∫øu c·∫ßn

#### `completeRepairCheck(actor, id, result, manager_comment)`
- Ho√†n th√†nh ki·ªÉm tra container
- C·∫≠p nh·∫≠t c·∫£ `RepairTicket` v√† `ServiceRequest` status

#### `updateRepairDetails(actor, id, data)`
- C·∫≠p nh·∫≠t th√¥ng tin chi ti·∫øt s·ª≠a ch·ªØa
- T√≠nh to√°n t·ª± ƒë·ªông `estimated_cost` t·ª´ ph·ª• t√πng v√† c√¥ng s·ª≠a ch·ªØa

#### `updateRequestStatusByContainer(containerNo, repairStatus)`
- ƒê·ªìng b·ªô tr·∫°ng th√°i `ServiceRequest` d·ª±a tr√™n `RepairTicket`

## üîê Validation Schemas

### createRepairSchema
```typescript
{
  code: string (required),
  container_no: string (optional),
  equipment_id: string (optional),
  problem_description: string (required),
  estimated_cost: number (optional),
  items: array (optional)
}
```

### listRepairsSchema
```typescript
{
  status: string (optional) - CHECKING, PENDING_ACCEPT, REPAIRING, CHECKED, REJECTED
}
```

### updateRepairDetailsSchema
```typescript
{
  problem_description: string (optional),
  selected_parts: string[] (optional),
  labor_cost: number (optional),
  technician_notes: string (optional),
  repair_notes: string (optional)
}
```

### completeCheckSchema
```typescript
{
  result: 'PASS' | 'FAIL' (required),
  manager_comment: string (optional)
}
```

## üîó T√≠ch h·ª£p v·ªõi c√°c module kh√°c

### ServiceRequest Module
- ƒê·ªìng b·ªô tr·∫°ng th√°i gi·ªØa `ServiceRequest` v√† `RepairTicket`
- S·ª≠ d·ª•ng `RequestStateMachine` ƒë·ªÉ qu·∫£n l√Ω tr·∫°ng th√°i

### Container Module
- Li√™n k·∫øt container v·ªõi phi·∫øu s·ª≠a ch·ªØa qua `container_no`

### Inventory Module
- Qu·∫£n l√Ω ph·ª• t√πng v√† t√≠nh to√°n chi ph√≠

## üß™ Testing

### Test Cases ch√≠nh
1. **T·∫°o phi·∫øu s·ª≠a ch·ªØa**: Ki·ªÉm tra t·∫°o th√†nh c√¥ng v·ªõi status `CHECKING`
2. **Ki·ªÉm tra container**: Ki·ªÉm tra chuy·ªÉn tr·∫°ng th√°i t·ª´ `GATE_IN` ‚Üí `CHECKING`
3. **Ho√†n th√†nh ki·ªÉm tra**: Ki·ªÉm tra chuy·ªÉn tr·∫°ng th√°i ‚Üí `CHECKED` ho·∫∑c `REJECTED`
4. **ƒê·ªìng b·ªô tr·∫°ng th√°i**: Ki·ªÉm tra `ServiceRequest` v√† `RepairTicket` ƒë·ªìng b·ªô
5. **C·∫≠p nh·∫≠t chi ti·∫øt**: Ki·ªÉm tra t√≠nh to√°n chi ph√≠ t·ª± ƒë·ªông

### API Testing
```bash
# Test t·∫°o phi·∫øu s·ª≠a ch·ªØa
curl -X POST http://localhost:1100/backend/maintenance/repairs \
  -H "Content-Type: application/json" \
  -d '{"code":"REP-001","container_no":"CONT-001","problem_description":"Test"}'

# Test l·∫•y danh s√°ch
curl http://localhost:1100/backend/maintenance/repairs

# Test ho√†n th√†nh ki·ªÉm tra
curl -X POST http://localhost:1100/backend/maintenance/repairs/1/complete-check \
  -H "Content-Type: application/json" \
  -d '{"result":"PASS"}'
```

## üöÄ Deployment

### Y√™u c·∫ßu h·ªá th·ªëng
- Node.js 16+
- PostgreSQL 12+
- Prisma ORM

### Environment Variables
```env
DATABASE_URL="postgresql://user:password@localhost:5432/container_manager"
JWT_SECRET="your-jwt-secret"
```

### Build v√† Deploy
```bash
# Install dependencies
npm install

# Build TypeScript
npm run build

# Run migrations
npx prisma migrate deploy

# Start production
npm start
```

## üîí B·∫£o m·∫≠t

### Authentication
- T·∫•t c·∫£ endpoints y√™u c·∫ßu JWT token
- S·ª≠ d·ª•ng `AuthRequest` middleware

### Authorization
- Ki·ªÉm tra quy·ªÅn truy c·∫≠p d·ª±a tr√™n role
- Validation input data v·ªõi Joi schemas

### Data Validation
- Sanitize input data
- Validate v·ªõi strict schemas
- SQL injection protection qua Prisma

## üìù Changelog

### Version 1.0.0
- ‚úÖ T·∫°o module b·∫£o tr√¨ c∆° b·∫£n
- ‚úÖ Qu·∫£n l√Ω phi·∫øu s·ª≠a ch·ªØa
- ‚úÖ Qu·∫£n l√Ω t·ªìn kho ph·ª• t√πng
- ‚úÖ T√≠ch h·ª£p v·ªõi ServiceRequest
- ‚úÖ Quy tr√¨nh ki·ªÉm tra container
- ‚úÖ T√≠nh to√°n chi ph√≠ t·ª± ƒë·ªông

### Version 1.1.0 (Planned)
- üîÑ Dashboard th·ªëng k√™ b·∫£o tr√¨
- üîÑ B√°o c√°o chi ph√≠ s·ª≠a ch·ªØa
- üîÑ Qu·∫£n l√Ω l·ªãch s·ª≠ s·ª≠a ch·ªØa
- üîÑ Notification system

## üêõ Troubleshooting

### L·ªói th∆∞·ªùng g·∫∑p

#### 1. L·ªói 400 Bad Request
- **Nguy√™n nh√¢n**: Validation schema kh√¥ng kh·ªõp v·ªõi input
- **Gi·∫£i ph√°p**: Ki·ªÉm tra `MaintenanceDtos.ts` v√† input data

#### 2. L·ªói ƒë·ªìng b·ªô tr·∫°ng th√°i
- **Nguy√™n nh√¢n**: `ServiceRequest` v√† `RepairTicket` kh√¥ng ƒë·ªìng b·ªô
- **Gi·∫£i ph√°p**: Ki·ªÉm tra `updateRequestStatusByContainer` method

#### 3. L·ªói t√≠nh to√°n chi ph√≠
- **Nguy√™n nh√¢n**: Ph·ª• t√πng kh√¥ng c√≥ gi√° ho·∫∑c `labor_cost` kh√¥ng h·ª£p l·ªá
- **Gi·∫£i ph√°p**: Ki·ªÉm tra `InventoryItem.price` v√† validation

### Debug Commands
```bash
# Ki·ªÉm tra logs
npm run dev

# Ki·ªÉm tra database
npx prisma studio

# Reset database
npx prisma migrate reset
```

## üîê T√≠nh nƒÉng ViewQuote (v2025-09-09)

### M√¥ t·∫£
T√≠nh nƒÉng `viewquote` ki·ªÉm so√°t quy·ªÅn xem h√≥a ƒë∆°n s·ª≠a ch·ªØa ·ªü c√°c trang kh√°c nhau trong h·ªá th·ªëng.

### C√°c gi√° tr·ªã viewquote

#### `viewquote = 0` (M·∫∑c ƒë·ªãnh)
- **√ù nghƒ©a**: Ch·ªâ page Maintenance/Repairs m·ªõi c√≥ th·ªÉ xem h√≥a ƒë∆°n s·ª≠a ch·ªØa
- **Tr·∫°ng th√°i**: ƒê√¢y l√† tr·∫°ng th√°i ban ƒë·∫ßu khi t·∫°o phi·∫øu s·ª≠a ch·ªØa

#### `viewquote = 1`
- **K√≠ch ho·∫°t**: Khi click button "G·ª≠i y√™u c·∫ßu x√°c nh·∫≠n" v·ªõi `repairtick status = PENDING_ACCEPT`
- **Hi·ªáu ·ª©ng**: Page Requests/Depot s·∫Ω hi·ªÉn th·ªã button "Xem h√≥a ƒë∆°n/G·ª≠i x√°c nh·∫≠n"
- **API**: `POST /maintenance/repairs/:id/confirmation-request`

#### `viewquote = 2`
- **K√≠ch ho·∫°t**: Khi ·ªü Depot page click button "G·ª≠i x√°c nh·∫≠n"
- **Hi·ªáu ·ª©ng**: Lu·ªìng hi·ªÉn th·ªã t·∫°i trang Customer ƒë√£ b·ªã g·ª° b·ªè; kh√¥ng c√≤n trang Customer.
- **API**: `POST /requests/:id/send-customer-confirmation`

### Lu·ªìng ho·∫°t ƒë·ªông
```
1. Maintenance/Repairs (viewquote = 0)
   ‚Üì Click "G·ª≠i y√™u c·∫ßu x√°c nh·∫≠n"
2. Depot c√≥ th·ªÉ xem h√≥a ƒë∆°n (viewquote = 1)
   ‚Üì Click "G·ª≠i x√°c nh·∫≠n"
3. Customer c√≥ th·ªÉ xem h√≥a ƒë∆°n v√† quy·∫øt ƒë·ªãnh (viewquote = 2)
```

### C·∫≠p nh·∫≠t Database
- **Migration**: `20250909010849_add_viewquote_to_repair_ticket`
- **Field**: `viewquote Int @default(0)`
- **Index**: Kh√¥ng c·∫ßn index ri√™ng v√¨ field n√†y ƒë∆∞·ª£c query c√πng v·ªõi container_no

## üìö T√†i li·ªáu tham kh·∫£o

- [Prisma Documentation](https://www.prisma.io/docs/)
- [Joi Validation](https://joi.dev/api/)
- [Express.js](https://expressjs.com/)
- [Node.js](https://nodejs.org/)

---

**L∆∞u √Ω**: Module n√†y ƒëang trong qu√° tr√¨nh ph√°t tri·ªÉn. Vui l√≤ng b√°o c√°o bugs v√† ƒë·ªÅ xu·∫•t c·∫£i ti·∫øn qua issue tracker.
