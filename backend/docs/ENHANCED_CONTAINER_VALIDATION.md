# üîí Enhanced Container Duplicate Validation

## T·ªïng quan

T√†i li·ªáu n√†y m√¥ t·∫£ logic validation n√¢ng cao ƒë·ªÉ ngƒÉn ch·∫∑n t·∫°o request import tr√πng l·∫∑p. H·ªá th·ªëng ki·ªÉm tra t·∫•t c·∫£ ngu·ªìn container trong depot ƒë·ªÉ ƒë·∫£m b·∫£o ch·ªâ cho ph√©p t·∫°o request import khi container th·ª±c s·ª± kh√¥ng c√≥ trong h·ªá th·ªëng.

## üéØ M·ª•c ƒë√≠ch

- **Ki·ªÉm tra to√†n di·ªán**: Ki·ªÉm tra t·∫•t c·∫£ ngu·ªìn container (ServiceRequest, RepairTicket, YardPlacement)
- **ƒê·ªìng b·ªô v·ªõi UI**: S·ª≠ d·ª•ng c√πng logic query nh∆∞ Yard v√† ContainersPage
- **NgƒÉn ch·∫∑n duplicate**: Kh√¥ng cho ph√©p t·∫°o request import v·ªõi container ƒë√£ c√≥ trong depot
- **Th√¥ng b√°o r√µ r√†ng**: Hi·ªÉn th·ªã l·ªói c·ª• th·ªÉ cho t·ª´ng tr∆∞·ªùng h·ª£p

## üîß Logic Validation N√¢ng Cao

### Backend Validation

**File:** `modules/requests/service/RequestBaseService.ts`

```typescript
/**
 * Ki·ªÉm tra container number ch∆∞a t·ªìn t·∫°i trong h·ªá th·ªëng
 * Ch·ªâ cho ph√©p t·∫°o request import m·ªõi khi container th·ª±c s·ª± kh√¥ng c√≥ trong depot
 * Ki·ªÉm tra t·∫•t c·∫£ ngu·ªìn: ServiceRequest, RepairTicket, YardPlacement
 */
private async validateContainerNotExists(container_no: string) {
    // S·ª≠ d·ª•ng query t∆∞∆°ng t·ª± nh∆∞ logic hi·ªÉn th·ªã container trong Yard/ContainersPage
    const containerExists = await prisma.$queryRaw<any[]>`
        WITH latest_sr AS (
            SELECT DISTINCT ON (sr.container_no)
                sr.container_no,
                sr.status as service_status,
                sr.gate_checked_at as gate_checked_at,
                sr.type as request_type
            FROM "ServiceRequest" sr
            WHERE sr.container_no IS NOT NULL
            ORDER BY sr.container_no, sr."createdAt" DESC
        ),
        rt_checked AS (
            SELECT DISTINCT ON (rt.container_no)
                rt.container_no,
                TRUE as repair_checked,
                rt."updatedAt" as updated_at
            FROM "RepairTicket" rt
            WHERE rt.status::text = 'CHECKED' AND rt.container_no IS NOT NULL
            ORDER BY rt.container_no, rt."updatedAt" DESC
        ),
        yard_placement AS (
            SELECT DISTINCT ON (yp.container_no)
                yp.container_no,
                yp.status as placement_status,
                yp.placed_at
            FROM "YardPlacement" yp 
            WHERE yp.status = 'OCCUPIED' 
                AND yp.removed_at IS NULL
                AND yp.container_no IS NOT NULL
            ORDER BY yp.container_no, yp.placed_at DESC
        )
        SELECT 
            COALESCE(sr.container_no, rt.container_no, yp.container_no) as container_no,
            sr.service_status,
            sr.gate_checked_at,
            sr.request_type,
            COALESCE(rt.repair_checked, FALSE) as repair_checked,
            yp.placement_status,
            yp.placed_at,
            CASE 
                WHEN sr.container_no IS NOT NULL THEN 'SERVICE_REQUEST'
                WHEN rt.container_no IS NOT NULL THEN 'REPAIR_TICKET'
                WHEN yp.container_no IS NOT NULL THEN 'YARD_PLACEMENT'
            END as source
        FROM latest_sr sr
        FULL OUTER JOIN rt_checked rt ON rt.container_no = sr.container_no
        FULL OUTER JOIN yard_placement yp ON yp.container_no = COALESCE(sr.container_no, rt.container_no)
        WHERE sr.container_no = ${container_no} 
            OR rt.container_no = ${container_no} 
            OR yp.container_no = ${container_no}
    `;

    if (containerExists.length === 0) {
        // Container kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng - cho ph√©p t·∫°o
        return;
    }

    const container = containerExists[0];

    // Ki·ªÉm tra t·ª´ng ngu·ªìn v√† ƒë∆∞a ra th√¥ng b√°o l·ªói ph√π h·ª£p
    if (container.source === 'SERVICE_REQUEST') {
        const isCompleted = ['COMPLETED', 'REJECTED', 'GATE_REJECTED'].includes(container.service_status);
        if (!isCompleted) {
            throw new Error(`Container ${container_no} ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng v·ªõi tr·∫°ng th√°i ${container.service_status}. Ch·ªâ c√≥ th·ªÉ t·∫°o request m·ªõi khi container kh√¥ng c√≤n trong h·ªá th·ªëng.`);
        }
    }

    if (container.source === 'REPAIR_TICKET') {
        throw new Error(`Container ${container_no} ƒëang trong quy tr√¨nh s·ª≠a ch·ªØa. Kh√¥ng th·ªÉ t·∫°o request import m·ªõi.`);
    }

    if (container.source === 'YARD_PLACEMENT') {
        throw new Error(`Container ${container_no} ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t v√†o yard v√† ch∆∞a ƒë∆∞·ª£c xu·∫•t. Kh√¥ng th·ªÉ t·∫°o request import m·ªõi.`);
    }
}
```

## üìã C√°c Ngu·ªìn Container ƒê∆∞·ª£c Ki·ªÉm Tra

### 1. ServiceRequest (∆Øu ti√™n cao nh·∫•t)
- **M√¥ t·∫£**: Container t·ª´ request import/export
- **ƒêi·ªÅu ki·ªán ch·∫∑n**: Status ch∆∞a ho√†n th√†nh
- **Status ƒë∆∞·ª£c ch·∫∑n**: PENDING, SCHEDULED, FORWARDED, GATE_IN, CHECKING, PENDING_ACCEPT, ACCEPT, CHECKED, POSITIONED, FORKLIFTING, IN_YARD, IN_CAR, GATE_OUT
- **Status cho ph√©p**: COMPLETED, REJECTED, GATE_REJECTED

### 2. RepairTicket (∆Øu ti√™n th·ª© 2)
- **M√¥ t·∫£**: Container trong quy tr√¨nh s·ª≠a ch·ªØa
- **ƒêi·ªÅu ki·ªán ch·∫∑n**: Status = 'CHECKED'
- **L√Ω do**: Container ƒëang ƒë∆∞·ª£c s·ª≠a ch·ªØa, kh√¥ng th·ªÉ t·∫°o request import

### 3. YardPlacement (∆Øu ti√™n th·∫•p nh·∫•t)
- **M√¥ t·∫£**: Container ƒë√£ ƒë∆∞·ª£c ƒë·∫∑t v√†o yard
- **ƒêi·ªÅu ki·ªán ch·∫∑n**: Status = 'OCCUPIED' v√† removed_at = null
- **L√Ω do**: Container ƒë√£ c√≥ trong b√£i, kh√¥ng th·ªÉ t·∫°o request import m·ªõi

## üîÑ Lu·ªìng X·ª≠ L√Ω N√¢ng Cao

```mermaid
graph TD
    A[User t·∫°o request import] --> B[validateContainerNotExists()]
    B --> C[Query t·∫•t c·∫£ ngu·ªìn container]
    C --> D{Container c√≥ t·ªìn t·∫°i?}
    D -->|Kh√¥ng| E[Cho ph√©p t·∫°o request]
    D -->|C√≥| F{X√°c ƒë·ªãnh ngu·ªìn}
    F -->|SERVICE_REQUEST| G{Status ho√†n th√†nh?}
    F -->|REPAIR_TICKET| H[Ch·∫∑n - ƒêang s·ª≠a ch·ªØa]
    F -->|YARD_PLACEMENT| I[Ch·∫∑n - ƒê√£ trong yard]
    G -->|C√≥| E
    G -->|Kh√¥ng| J[Ch·∫∑n - ƒêang ho·∫°t ƒë·ªông]
    H --> K[Hi·ªÉn th·ªã l·ªói s·ª≠a ch·ªØa]
    I --> L[Hi·ªÉn th·ªã l·ªói yard]
    J --> M[Hi·ªÉn th·ªã l·ªói status]
    E --> N[T·∫°o request th√†nh c√¥ng]
```

## üß™ Testing

### Test Script

**File:** `test-enhanced-container-validation.js`

```javascript
// Test v·ªõi t·∫•t c·∫£ ngu·ªìn container
const allContainers = await prisma.$queryRaw`
    WITH latest_sr AS (...),
    rt_checked AS (...),
    yard_placement AS (...)
    SELECT 
        COALESCE(sr.container_no, rt.container_no, yp.container_no) as container_no,
        CASE 
            WHEN sr.container_no IS NOT NULL THEN 'SERVICE_REQUEST'
            WHEN rt.container_no IS NOT NULL THEN 'REPAIR_TICKET'
            WHEN yp.container_no IS NOT NULL THEN 'YARD_PLACEMENT'
        END as source
    FROM latest_sr sr
    FULL OUTER JOIN rt_checked rt ON rt.container_no = sr.container_no
    FULL OUTER JOIN yard_placement yp ON yp.container_no = COALESCE(sr.container_no, rt.container_no)
    WHERE sr.container_no IS NOT NULL 
        OR rt.container_no IS NOT NULL 
        OR yp.container_no IS NOT NULL
`;
```

### Test Cases

1. **Container t·ª´ ServiceRequest v·ªõi status PENDING** ‚Üí ‚ùå Ch·∫∑n
2. **Container t·ª´ ServiceRequest v·ªõi status COMPLETED** ‚Üí ‚úÖ Cho ph√©p
3. **Container t·ª´ RepairTicket** ‚Üí ‚ùå Ch·∫∑n
4. **Container t·ª´ YardPlacement** ‚Üí ‚ùå Ch·∫∑n
5. **Container kh√¥ng t·ªìn t·∫°i** ‚Üí ‚úÖ Cho ph√©p

## üìä K·∫øt Qu·∫£ Test

```
üß™ Test Enhanced Container Validation Logic...

1. Ki·ªÉm tra containers hi·ªán c√≥ trong t·∫•t c·∫£ ngu·ªìn:
   T√¨m th·∫•y 1 containers trong h·ªá th·ªëng:
   - ISO 1234 (SERVICE_REQUEST) - Status: PENDING

2. Test validation logic:
   Testing v·ªõi container: ISO 1234
   Source: SERVICE_REQUEST
   Status: PENDING
   ‚ùå Container ISO 1234 ƒë√£ t·ªìn t·∫°i trong h·ªá th·ªëng v·ªõi tr·∫°ng th√°i PENDING
   ‚úÖ Validation s·∫Ω ch·∫∑n t·∫°o request m·ªõi cho container n√†y

3. Test v·ªõi container kh√¥ng t·ªìn t·∫°i:
   ‚úÖ Container TEST999999 kh√¥ng t·ªìn t·∫°i trong h·ªá th·ªëng
   ‚úÖ Validation s·∫Ω cho ph√©p t·∫°o request m·ªõi cho container n√†y

‚úÖ Test ho√†n th√†nh!
```

## üéØ L·ª£i √çch

### 1. **ƒê·ªìng b·ªô v·ªõi UI**
- S·ª≠ d·ª•ng c√πng query logic nh∆∞ Yard v√† ContainersPage
- ƒê·∫£m b·∫£o consistency gi·ªØa validation v√† hi·ªÉn th·ªã

### 2. **Ki·ªÉm tra to√†n di·ªán**
- Ki·ªÉm tra t·∫•t c·∫£ ngu·ªìn container trong depot
- Kh√¥ng b·ªè s√≥t tr∆∞·ªùng h·ª£p n√†o

### 3. **Th√¥ng b√°o l·ªói r√µ r√†ng**
- L·ªói c·ª• th·ªÉ cho t·ª´ng ngu·ªìn container
- Gi√∫p user hi·ªÉu t·∫°i sao kh√¥ng th·ªÉ t·∫°o request

### 4. **Performance t·ªëi ∆∞u**
- S·ª≠ d·ª•ng single query thay v√¨ multiple queries
- Index ƒë∆∞·ª£c t·ªëi ∆∞u cho c√°c tr∆∞·ªùng h·ª£p s·ª≠ d·ª•ng

## üìÅ File Mapping

### Backend Files

| File | Thay ƒë·ªïi | M√¥ t·∫£ |
|------|----------|-------|
| `RequestBaseService.ts` | ‚úÖ C·∫≠p nh·∫≠t | Logic validation n√¢ng cao |
| `test-enhanced-container-validation.js` | ‚úÖ M·ªõi | Test script cho logic m·ªõi |

### Frontend Files

| File | Thay ƒë·ªïi | M√¥ t·∫£ |
|------|----------|-------|
| `RequestForm.tsx` | ‚ö™ Kh√¥ng ƒë·ªïi | ƒê√£ c√≥ error handling |

## üöÄ Deployment

### Backend Changes
- ‚úÖ Deploy `RequestBaseService.ts` v·ªõi logic m·ªõi
- ‚úÖ Test validation v·ªõi t·∫•t c·∫£ ngu·ªìn container
- ‚úÖ Monitor error logs

### Database
- ‚ö™ Kh√¥ng c·∫ßn migration
- ‚ö™ S·ª≠ d·ª•ng existing indexes

## üîç Monitoring

### Error Tracking
```typescript
// Track validation errors by source
const trackValidationError = (containerNo: string, source: string, error: string) => {
    analytics.track('enhanced_container_validation_error', {
        container_no: containerNo,
        source: source,
        error_message: error,
        timestamp: new Date().toISOString()
    });
};
```

### Metrics
- S·ªë l∆∞·ª£ng request b·ªã ch·∫∑n theo ngu·ªìn container
- Container numbers b·ªã duplicate nhi·ªÅu nh·∫•t
- Th·ªùi gian response validation

## üìù Notes

1. **Backward Compatible**: Kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn code hi·ªán c√≥
2. **Performance**: Single query thay v√¨ multiple queries
3. **Maintainable**: Logic r√µ r√†ng, d·ªÖ hi·ªÉu
4. **Testable**: C√≥ test script ƒë·∫ßy ƒë·ªß
5. **Scalable**: C√≥ th·ªÉ m·ªü r·ªông th√™m ngu·ªìn container kh√°c

## üîÑ Future Enhancements

1. **Real-time Validation**: Ki·ªÉm tra khi user nh·∫≠p container number
2. **Bulk Validation**: Validate nhi·ªÅu containers c√πng l√∫c
3. **Cache**: Cache k·∫øt qu·∫£ validation ƒë·ªÉ t·ªëi ∆∞u performance
4. **Audit Trail**: Log chi ti·∫øt c√°c l·∫ßn validation
5. **Tenant Isolation**: Validation theo tenant
